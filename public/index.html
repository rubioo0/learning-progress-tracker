<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learning Progress Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Highlight.js for code syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- Markdown parsing library -->
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <script>
        // Theme management functions
        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.classList.contains('dark');
            
            if (isDark) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }
            
            // Update lucide icons after theme change
            setTimeout(() => {
                lucide.createIcons();
            }, 100);
        }
        
        // Fullscreen management functions
        let isFullscreen = false;
        
        function toggleFullscreen() {
            const body = document.body;
            const fullscreenIcon = document.getElementById('fullscreen-icon');
            
            if (!isFullscreen) {
                // Enter fullscreen
                enterFullscreen();
            } else {
                // Exit fullscreen
                exitFullscreen();
            }
        }
        
        function enterFullscreen() {
            const body = document.body;
            const fullscreenIcon = document.getElementById('fullscreen-icon');
            
            // Try to use browser's fullscreen API first
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen().then(() => {
                    setFullscreenState(true);
                }).catch(() => {
                    // Fallback to CSS fullscreen
                    cssFullscreen(true);
                });
            } else if (document.documentElement.webkitRequestFullscreen) {
                document.documentElement.webkitRequestFullscreen();
                setFullscreenState(true);
            } else if (document.documentElement.msRequestFullscreen) {
                document.documentElement.msRequestFullscreen();
                setFullscreenState(true);
            } else {
                // Fallback to CSS fullscreen
                cssFullscreen(true);
            }
        }
        
        function exitFullscreen() {
            // Try to use browser's fullscreen API first
            if (document.exitFullscreen) {
                document.exitFullscreen().then(() => {
                    setFullscreenState(false);
                }).catch(() => {
                    // Fallback to CSS fullscreen
                    cssFullscreen(false);
                });
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
                setFullscreenState(false);
            } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
                setFullscreenState(false);
            } else {
                // Fallback to CSS fullscreen
                cssFullscreen(false);
            }
        }
        
        function cssFullscreen(enable) {
            const body = document.body;
            
            if (enable) {
                body.classList.add('fullscreen-mode');
                setFullscreenState(true);
                showFullscreenNotification('Entered fullscreen mode. Press ESC or click the minimize button to exit.');
            } else {
                body.classList.remove('fullscreen-mode');
                setFullscreenState(false);
            }
        }
        
        function setFullscreenState(enabled) {
            isFullscreen = enabled;
            const fullscreenIcon = document.getElementById('fullscreen-icon');
            
            if (enabled) {
                fullscreenIcon.setAttribute('data-lucide', 'minimize');
                fullscreenIcon.title = 'Exit fullscreen';
            } else {
                fullscreenIcon.setAttribute('data-lucide', 'maximize');
                fullscreenIcon.title = 'Enter fullscreen';
            }
            
            // Update lucide icons
            setTimeout(() => {
                lucide.createIcons();
            }, 100);
            
            // Store fullscreen state
            localStorage.setItem('fullscreenMode', enabled.toString());
        }
        
        function showFullscreenNotification(message) {
            // Remove existing notification if any
            const existingNotification = document.querySelector('.fullscreen-notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            // Create new notification
            const notification = document.createElement('div');
            notification.className = 'fullscreen-notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Remove notification after animation
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }
        
        // Listen for fullscreen changes
        function handleFullscreenChange() {
            const isCurrentlyFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement);
            
            if (!isCurrentlyFullscreen && isFullscreen) {
                // User exited fullscreen using ESC or F11
                setFullscreenState(false);
                cssFullscreen(false);
            }
        }
        
        // Add event listeners for fullscreen changes
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        document.addEventListener('msfullscreenchange', handleFullscreenChange);
    </script>
    <style>
        .status-not-started { 
            background-color: #f3f4f6; 
            border-color: #d1d5db; 
            color: #374151; 
            border-left: 4px solid #9CA3AF;
        }
        .status-in-progress { 
            background-color: #fef3c7; 
            border-color: #fcd34d; 
            color: #92400e; 
            border-left: 4px solid #F59E0B;
        }
        .status-completed { 
            background-color: #d1fae5; 
            border-color: #86efac; 
            color: #065f46; 
            border-left: 4px solid #10B981;
        }
        
        .progress-bar {
            transition: width 0.3s ease-in-out;
        }
        
        .topic-card {
            transition: all 0.2s ease-in-out;
        }
        
        .topic-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .topic-details {
            transition: all 0.3s ease-in-out;
        }
        
        .topic-chevron {
            transition: transform 0.2s ease;
        }
        
        /* Dark theme specific styles */
        .dark .status-not-started {
            border-left-color: #6B7280;
        }

        .status-not-started { 
            background-color: #f3f4f6; 
            border-color: #d1d5db; 
            color: #374151; 
            border-left: 4px solid #9CA3AF;
        }
        .status-in-progress { 
            background-color: #fef3c7; 
            border-color: #fcd34d; 
            color: #92400e; 
            border-left: 4px solid #F59E0B;
        }
        .status-completed { 
            background-color: #d1fae5; 
            border-color: #86efac; 
            color: #065f46; 
            border-left: 4px solid #10B981;
        }
        
        .progress-bar {
            transition: width 0.3s ease-in-out;
        }
        
        .topic-card {
            transition: all 0.2s ease-in-out;
        }
        
        .topic-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .topic-details {
            transition: all 0.3s ease-in-out;
        }
        
        .topic-chevron {
            transition: transform 0.2s ease;
        }
        
        /* Dark theme specific styles */
        .dark .status-not-started {
            border-left-color: #6B7280;
        }
        
        .dark .status-in-progress {
            border-left-color: #FBBF24;
        }
        
        .dark .status-completed {
            border-left-color: #34D399;
        }
        
        /* Smooth transitions for theme switching */
        * {
            transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
        }
        
        /* Custom scrollbar for dark theme */
        .dark ::-webkit-scrollbar {
            width: 8px;
        }
        
        .dark ::-webkit-scrollbar-track {
            background: #374151;
        }
        
        .dark ::-webkit-scrollbar-thumb {
            background: #6B7280;
            border-radius: 4px;
        }
        
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #9CA3AF;
        }

        .achievement-popup {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .dark .status-in-progress {
            border-left-color: #FBBF24;
        }
        
        .dark .status-completed {
            border-left-color: #34D399;
        }
        
        /* Smooth transitions for theme switching */
        * {
            transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
        }
        
        /* Custom scrollbar for dark theme */
        .dark ::-webkit-scrollbar {
            width: 8px;
        }
        
        .dark ::-webkit-scrollbar-track {
            background: #374151;
        }
        
        /* Ensure preview modals are always on top */
        #file-preview-modal, #excel-preview-modal {
            z-index: 10000 !important;
        }
        
        .dark ::-webkit-scrollbar-thumb {
            background: #6B7280;
            border-radius: 4px;
        }
        
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #9CA3AF;
        }

        .achievement-popup {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Questions section styles */
        .question-item {
            transition: all 0.2s ease;
        }
        
        .question-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .question-answered {
            opacity: 0.8;
        }
        
        .question-answered .question-text {
            text-decoration: line-through;
        }
        
        /* Markdown preview styles */
        .markdown-content {
            line-height: 1.6;
            color: #374151;
        }
        
        .dark .markdown-content {
            color: #E5E7EB;
        }
        
        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3,
        .markdown-content h4,
        .markdown-content h5,
        .markdown-content h6 {
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            color: #111827;
        }
        
        .dark .markdown-content h1,
        .dark .markdown-content h2,
        .dark .markdown-content h3,
        .dark .markdown-content h4,
        .dark .markdown-content h5,
        .dark .markdown-content h6 {
            color: #F9FAFB;
        }
        
        .markdown-content h1 {
            font-size: 1.875rem;
            border-bottom: 2px solid #E5E7EB;
            padding-bottom: 0.5rem;
        }
        
        .dark .markdown-content h1 {
            border-bottom-color: #4B5563;
        }
        
        .markdown-content h2 {
            font-size: 1.5rem;
            border-bottom: 1px solid #E5E7EB;
            padding-bottom: 0.25rem;
        }
        
        .dark .markdown-content h2 {
            border-bottom-color: #4B5563;
        }
        
        .markdown-content h3 {
            font-size: 1.25rem;
        }
        
        .markdown-content p {
            margin-bottom: 1rem;
        }
        
        .markdown-content ul,
        .markdown-content ol {
            margin-bottom: 1rem;
            padding-left: 2rem;
        }
        .markdown-content ul {
            list-style-type: disc;
            margin-bottom: 1rem;
            padding-left: 2rem;
        }
        .markdown-content ol {
            list-style-type: decimal;
        }
        .markdown-content ul ul {
            list-style-type: circle;
        }
        .markdown-content ul ul ul {
            list-style-type: square;
        }
        .markdown-content li {
            margin-bottom: 0.25rem;
        }
        
        .markdown-content blockquote {
            border-left: 4px solid #3B82F6;
            background: #EFF6FF;
            padding: 1rem;
            margin: 1rem 0;
            font-style: italic;
        }
        
        .dark .markdown-content blockquote {
            background: #1E3A8A20;
            border-left-color: #60A5FA;
        }
        
        .markdown-content code {
            background: #F3F4F6;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
        }
        
        .dark .markdown-content code {
            background: #374151;
        }
        
        .markdown-content pre {
            background: #F3F4F6;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 1rem 0;
        }
        
        .dark .markdown-content pre {
            background: #374151;
        }
        
        .markdown-content pre code {
            background: transparent;
            padding: 0;
        }
        
        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        
        .markdown-content th,
        .markdown-content td {
            border: 1px solid #D1D5DB;
            padding: 0.75rem;
            text-align: left;
        }
        
        .dark .markdown-content th,
        .dark .markdown-content td {
            border-color: #4B5563;
        }
        
        .markdown-content th {
            background: #F9FAFB;
            font-weight: 600;
        }
        
        .dark .markdown-content th {
            background: #374151;
        }
        
        .markdown-content hr {
            border: none;
            border-top: 2px solid #E5E7EB;
            margin: 2rem 0;
        }
        
        .dark .markdown-content hr {
            border-top-color: #4B5563;
        }
        
        .markdown-content strong {
            font-weight: 600;
        }
        
        .markdown-content em {
            font-style: italic;
        }
        
        /* Fullscreen styles */
        .fullscreen-mode {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 9999 !important;
            background: white !important;
            overflow: auto !important;
        }
        
        .dark .fullscreen-mode {
            background: #111827 !important;
        }
        
        .fullscreen-mode .max-w-7xl {
            max-width: none !important;
            margin: 0 !important;
            padding: 1rem !important;
        }
        
        /* Fullscreen notification */
        .fullscreen-notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            z-index: 10000;
            animation: fadeInOut 3s ease-in-out;
        }
        
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            10%, 90% { opacity: 1; }
        }
        
        /* Modal fullscreen styles */
        .modal-fullscreen {
            padding: 0 !important;
        }
        
        .modal-fullscreen .bg-white,
        .modal-fullscreen .dark\:bg-gray-800 {
            border-radius: 0 !important;
            box-shadow: none !important;
            border: none !important;
            height: 100vh !important;
            overflow-y: auto !important;
        }
        
        /* Fix content height in fullscreen modals */
        .modal-fullscreen .max-h-96 {
            max-height: none !important;
            height: calc(100vh - 200px) !important;
        }
        
        .modal-fullscreen .max-h-\[80vh\] {
            max-height: none !important;
            height: calc(100vh - 150px) !important;
        }
        
        /* Specific targeting for preview content areas */
        .modal-fullscreen .preview-content-area {
            max-height: calc(100vh - 250px) !important;
            height: calc(100vh - 250px) !important;
        }
        
    </style>
    <script>
        // Theme management - Initialize before page loads
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.documentElement.classList.add('dark');
            }
        }
        
        // Initialize theme immediately
        initTheme();
    </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen transition-colors duration-200">

    <!-- Learning Timer Notification -->
    <div id="timer-notification" class="fixed top-6 right-6 z-50 bg-red-600 text-white px-6 py-4 rounded-lg shadow-lg hidden">
        <span id="timer-message">Session expired!</span>
    </div>

    <!-- Simple Time Tracking Section -->
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 mb-8">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
            <div class="text-center">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Learning Time Tracker</h2>
                
                <!-- Timer Display -->
                <div class="mb-4">
                    <div class="text-3xl font-mono text-blue-600 dark:text-blue-400" id="learning-timer-display">00:00:00</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400 mt-1" id="total-time-display">Total: 0h 0m</div>
                </div>
            </div>
        </div>
    </div>
    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-3">
                    <i data-lucide="book-open" class="w-8 h-8 text-blue-600 dark:text-blue-400"></i>
                    <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Learning Progress Tracker</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- Session Timer -->
                    <!-- <div class="flex items-center space-x-2 bg-orange-50 dark:bg-orange-900/30 px-3 py-2 rounded-lg">
                        <i data-lucide="clock" class="w-5 h-5 text-orange-600 dark:text-orange-400"></i>
                        <span class="font-semibold text-orange-700 dark:text-orange-300" id="session-timer">00:00</span>
                    </div> -->
                    <!-- Session Controls -->
                    <!-- <button id="start-session-btn" onclick="startLearningSession()" 
                            class="bg-green-600 hover:bg-green-700 dark:bg-green-700 dark:hover:bg-green-600 text-white px-3 py-2 rounded-lg transition-colors text-sm">
                        <i data-lucide="play" class="w-4 h-4 inline mr-1"></i>
                        Start Session
                    </button> -->
                    <button id="terminate-session-btn" onclick="terminateSession()" 
                            class="bg-red-600 hover:bg-red-700 dark:bg-red-700 dark:hover:bg-red-600 text-white px-3 py-2 rounded-lg transition-colors text-sm hidden">
                        <i data-lucide="square" class="w-4 h-4 inline mr-1"></i>
                        Terminate Session
                    </button>
                    <!-- Clear Today's Data Button -->
                    <button id="clear-today-btn" onclick="clearTodayData()" 
                            class="bg-yellow-600 hover:bg-yellow-700 dark:bg-yellow-700 dark:hover:bg-yellow-600 text-white px-3 py-2 rounded-lg transition-colors text-sm" title="Clear today's learning data">
                        <i data-lucide="trash-2" class="w-4 h-4 inline mr-1"></i>
                        Clear Today
                    </button>
                    <button id="learning-control-btn" onclick="toggleLearningTimer()" 
                            class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg transition-colors text-sm" title="Start/Stop learning timer">
                        <i data-lucide="play" class="w-4 h-4 inline mr-1"></i>
                        Start Learning
                    </button>
                    <!-- Fullscreen Toggle Button -->
                    <button id="fullscreen-toggle" class="p-2 rounded-lg bg-gray-100 hover:bg-gray-200 dark:bg-gray-800 dark:hover:bg-gray-700 transition-colors duration-200" title="Toggle fullscreen">
                        <i data-lucide="maximize" class="w-5 h-5 text-gray-700 dark:text-gray-300" id="fullscreen-icon"></i>
                    </button>
                    <!-- Theme Toggle Button -->
                    <button id="theme-toggle" class="p-2 rounded-lg bg-gray-100 hover:bg-gray-200 dark:bg-gray-800 dark:hover:bg-gray-700 transition-colors duration-200" title="Toggle theme">
                        <i data-lucide="sun" class="w-5 h-5 text-gray-700 dark:text-gray-300 hidden dark:block"></i>
                        <i data-lucide="moon" class="w-5 h-5 text-gray-700 dark:text-gray-300 block dark:hidden"></i>
                    </button>
                    <div class="flex items-center space-x-2 bg-blue-50 dark:bg-blue-900/30 px-3 py-2 rounded-lg">
                        <i data-lucide="zap" class="w-5 h-5 text-blue-600 dark:text-blue-400"></i>
                        <span class="font-semibold text-blue-700 dark:text-blue-300" id="points-display">0 Points</span>
                    </div>
                    <div class="flex items-center space-x-2 bg-purple-50 dark:bg-purple-900/30 px-3 py-2 rounded-lg">
                        <i data-lucide="star" class="w-5 h-5 text-purple-600 dark:text-purple-400"></i>
                        <span class="font-semibold text-purple-700 dark:text-purple-300" id="level-display">Level 1</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Progress Dashboard -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Your Progress</h2>
            
            <!-- Progress Bar -->
            <div class="mb-6">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Overall Completion</span>
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300" id="progress-percentage">0%</span>
                </div>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3">
                    <div class="bg-gradient-to-r from-blue-500 to-green-500 h-3 rounded-full progress-bar" 
                         style="width: 0%" id="progress-bar"></div>
                </div>
            </div>
            
            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-gray-900 dark:text-white" id="total-topics">0</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">Total Topics</div>
                </div>
                <div class="bg-green-50 dark:bg-green-900/30 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-green-600 dark:text-green-400" id="completed-topics">0</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">Completed</div>
                </div>
                <div class="bg-yellow-50 dark:bg-yellow-900/30 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-yellow-600 dark:text-yellow-400" id="in-progress-topics">0</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">In Progress</div>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-gray-600 dark:text-gray-400" id="not-started-topics">0</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">Not Started</div>
                </div>
            </div>
        </div>

        <!-- Learning Calendar -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Learning Calendar</h2>
            
            <!-- Calendar Navigation -->
            <div class="flex justify-between items-center mb-4">
                <button onclick="changeTimeTrackingCalendarMonth(-1)" class="p-2 rounded-lg bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 transition-colors">
                    <i data-lucide="chevron-left" class="w-4 h-4 text-gray-600 dark:text-gray-300"></i>
                </button>
                <h3 class="text-lg font-medium text-gray-900 dark:text-white" id="calendar-month-year"></h3>
                <button onclick="changeTimeTrackingCalendarMonth(1)" class="p-2 rounded-lg bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 transition-colors">
                    <i data-lucide="chevron-right" class="w-4 h-4 text-gray-600 dark:text-gray-300"></i>
                </button>
            </div>
            
            <!-- Calendar Grid -->
            <div class="grid grid-cols-7 gap-1 text-center">
                <!-- Day Headers -->
                <div class="font-medium text-gray-600 dark:text-gray-400 py-2">Sun</div>
                <div class="font-medium text-gray-600 dark:text-gray-400 py-2">Mon</div>
                <div class="font-medium text-gray-600 dark:text-gray-400 py-2">Tue</div>
                <div class="font-medium text-gray-600 dark:text-gray-400 py-2">Wed</div>
                <div class="font-medium text-gray-600 dark:text-gray-400 py-2">Thu</div>
                <div class="font-medium text-gray-600 dark:text-gray-400 py-2">Fri</div>
                <div class="font-medium text-gray-600 dark:text-gray-400 py-2">Sat</div>
                <!-- Calendar Days -->
                <div id="calendar-days" class="col-span-7 grid grid-cols-7 gap-1">
                    <!-- Days will be populated by JavaScript -->
                </div>
            </div>
            
            <!-- Calendar Legend -->
            <div class="flex justify-center items-center space-x-4 mt-4 text-xs">
                <div class="flex items-center space-x-1">
                    <div class="w-3 h-3 bg-green-500 rounded"></div>
                    <span class="text-gray-600 dark:text-gray-400">60+ min</span>
                </div>
                <div class="flex items-center space-x-1">
                    <div class="w-3 h-3 bg-green-300 rounded"></div>
                    <span class="text-gray-600 dark:text-gray-400">30+ min</span>
                </div>
                <div class="flex items-center space-x-1">
                    <div class="w-3 h-3 bg-green-100 border border-green-300 rounded"></div>
                    <span class="text-gray-600 dark:text-gray-400">Any learning</span>
                </div>
                <div class="flex items-center space-x-1">
                    <div class="w-3 h-3 bg-gray-300 dark:bg-gray-600 rounded"></div>
                    <span class="text-gray-600 dark:text-gray-400">No activity</span>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-8">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Manage Your Curriculum</h3>
            <div class="flex flex-wrap gap-4 mb-4">
                <button onclick="loadSampleData()" 
                        class="bg-blue-600 hover:bg-blue-700 dark:bg-blue-700 dark:hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                    <i data-lucide="database" class="w-4 h-4 inline mr-2"></i>
                    Load Sample Curriculum
                </button>
                <label class="bg-green-600 hover:bg-green-700 dark:bg-green-700 dark:hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors cursor-pointer">
                    <i data-lucide="upload" class="w-4 h-4 inline mr-2"></i>
                    Import Excel File
                    <input type="file" id="excel-upload" accept=".xlsx,.xls" class="hidden" onchange="handleExcelUpload()">
                </label>
                <button onclick="previewExcel()" id="preview-btn" 
                        class="bg-purple-600 hover:bg-purple-700 dark:bg-purple-700 dark:hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition-colors hidden">
                    <i data-lucide="eye" class="w-4 h-4 inline mr-2"></i>
                    Preview Excel Structure
                </button>
                <button onclick="clearCurriculum()" 
                        class="bg-red-600 hover:bg-red-700 dark:bg-red-700 dark:hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                    <i data-lucide="trash-2" class="w-4 h-4 inline mr-2"></i>
                    Clear All Data
                </button>
                <button onclick="toggleView()" id="view-toggle" 
                        class="bg-gray-600 hover:bg-gray-700 dark:bg-gray-700 dark:hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                    <i data-lucide="grid" class="w-4 h-4 inline mr-2"></i>
                    Switch to Grid View
                </button>
            </div>
            
            <!-- Excel Import Guidelines for User's Format -->
            <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
                <h4 class="font-medium text-blue-900 dark:text-blue-300 mb-2">Your Excel File Format</h4>
                <p class="text-sm text-blue-700 dark:text-blue-400 mb-2">The system expects this specific structure for each sheet:</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-xs">
                    <div class="bg-blue-100 dark:bg-blue-800/30 rounded px-3 py-2">
                        <strong class="text-blue-900 dark:text-blue-200">Cell A1:</strong> <span class="text-blue-800 dark:text-blue-300">Level (e.g., "Junior Test Automation Engineer")</span>
                    </div>
                    <div class="bg-blue-100 dark:bg-blue-800/30 rounded px-3 py-2">
                        <strong class="text-blue-900 dark:text-blue-200">Cell B1:</strong> <span class="text-blue-800 dark:text-blue-300">Task Name (e.g., "Perform/Execute tests...")</span>
                    </div>
                    <div class="bg-blue-100 dark:bg-blue-800/30 rounded px-3 py-2">
                        <strong class="text-blue-900 dark:text-blue-200">Column C:</strong> <span class="text-blue-800 dark:text-blue-300">Labels (Descriptions, ARTIFACTS, NEBo Tasks, Outcomes, Learning Resources)</span>
                    </div>
                    <div class="bg-blue-100 dark:bg-blue-800/30 rounded px-3 py-2">
                        <strong class="text-blue-900 dark:text-blue-200">Column D:</strong> <span class="text-blue-800 dark:text-blue-300">Values corresponding to Column C labels</span>
                    </div>
                </div>
                <p class="text-xs text-blue-600 mt-2">The system will process all 16 sheets automatically and combine the C/D column data into comprehensive descriptions.</p>
            </div>
        </div>

        <!-- Topics Container -->
        <div id="topics-container">
            <!-- Topics will be loaded here -->
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="text-center py-12 hidden">
            <i data-lucide="book-open" class="w-16 h-16 text-gray-400 dark:text-gray-500 mx-auto mb-4"></i>
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">No Topics Yet</h3>
            <p class="text-gray-600 dark:text-gray-400 mb-6">Get started by loading sample data or importing your Excel file.</p>
            <button onclick="loadSampleData()" 
                    class="bg-blue-600 hover:bg-blue-700 dark:bg-blue-700 dark:hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition-colors">
                Load Sample Curriculum
            </button>
        </div>
    </main>

    <!-- Achievement Popup -->
    <div id="achievement-popup" class="fixed top-4 right-4 bg-white dark:bg-gray-800 border-l-4 border-yellow-400 dark:border-yellow-500 rounded-lg shadow-lg p-4 max-w-sm hidden achievement-popup">
        <div class="flex items-start">
            <i data-lucide="trophy" class="w-6 h-6 text-yellow-500 dark:text-yellow-400 mt-0.5 mr-3"></i>
            <div>
                <h4 class="font-semibold text-gray-900 dark:text-white" id="achievement-title">Achievement Unlocked!</h4>
                <p class="text-sm text-gray-600 dark:text-gray-300" id="achievement-description">You've earned a new achievement!</p>
            </div>
        </div>
    </div>

    <!-- Excel Preview Modal -->
    <div id="excel-preview-modal" class="fixed inset-0 bg-black bg-opacity-50 dark:bg-black dark:bg-opacity-70 hidden z-[9999] flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-4xl w-full p-6 max-h-[80vh] overflow-y-auto border border-gray-200 dark:border-gray-700">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Excel File Preview</h3>
                <div class="flex items-center space-x-2">
                    <button onclick="toggleModalFullscreen('excel-preview-modal')" class="text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300" title="Toggle fullscreen">
                        <i data-lucide="maximize" class="w-5 h-5"></i>
                    </button>
                    <button onclick="closeExcelPreview()" class="text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
            
            <div id="excel-preview-content">
                <!-- Preview content will be loaded here -->
            </div>
            
            <div class="flex space-x-3 mt-6">
                <button onclick="proceedWithImport()" 
                        class="flex-1 bg-green-600 hover:bg-green-700 dark:bg-green-700 dark:hover:bg-green-600 text-white py-2 rounded-lg transition-colors">
                    Import Data
                </button>
                <button onclick="closeExcelPreview()" 
                        class="flex-1 bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-700 dark:text-gray-200 py-2 rounded-lg transition-colors">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- File Preview Modal -->
    <div id="file-preview-modal" class="fixed inset-0 bg-black bg-opacity-50 dark:bg-black dark:bg-opacity-70 hidden z-[9999] flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-4xl w-full p-6 max-h-[80vh] overflow-y-auto border border-gray-200 dark:border-gray-700">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white" id="file-preview-title">File Preview</h3>
                <div class="flex items-center space-x-2">
                    <button onclick="toggleModalFullscreen('file-preview-modal')" class="text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300" title="Toggle fullscreen">
                        <i data-lucide="maximize" class="w-5 h-5"></i>
                    </button>
                    <button onclick="closeFilePreview()" class="text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
            
            <div id="file-preview-content">
                <!-- Preview content will be loaded here -->
            </div>
            
            <div class="flex justify-end mt-6">
                <button onclick="closeFilePreview()" 
                        class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-700 dark:text-gray-200 px-4 py-2 rounded-lg transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Session Completion Modal -->
    <div id="session-modal" class="fixed inset-0 bg-black bg-opacity-50 dark:bg-black dark:bg-opacity-70 hidden z-[10000] flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full p-6 border border-gray-200 dark:border-gray-700">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-orange-100 dark:bg-orange-900/30 mb-4">
                    <i data-lucide="clock" class="w-6 h-6 text-orange-600 dark:text-orange-400"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Learning Session Ended</h3>
                <p class="text-gray-600 dark:text-gray-400 mb-6">You've completed 1 hour of learning! Would you like to continue?</p>
                
                <div class="flex space-x-3">
                    <button onclick="continueSession()" 
                            class="flex-1 bg-green-600 hover:bg-green-700 dark:bg-green-700 dark:hover:bg-green-600 text-white py-3 rounded-lg transition-colors font-medium">
                        <i data-lucide="play" class="w-4 h-4 inline mr-2"></i>
                        Continue Learning
                    </button>
                    <button onclick="closeApp()" 
                            class="flex-1 bg-red-600 hover:bg-red-700 dark:bg-red-700 dark:hover:bg-red-600 text-white py-3 rounded-lg transition-colors font-medium">
                        <i data-lucide="power" class="w-4 h-4 inline mr-2"></i>
                        Close App
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Topic Detail Modal -->
    <div id="topic-modal" class="fixed inset-0 bg-black bg-opacity-50 dark:bg-black dark:bg-opacity-70 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full p-6 border border-gray-200 dark:border-gray-700">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white" id="modal-title">Topic Details</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status</label>
                    <select id="modal-status" class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400">
                        <option value="not-started">Not Started</option>
                        <option value="in-progress">In Progress</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Notes</label>
                    <textarea id="modal-notes" rows="4" 
                              class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400"
                              placeholder="Add your notes, reflections, or resources..."></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Questions for Research</label>
                    <div class="space-y-2" id="modal-questions-list">
                        <!-- Questions will be populated here -->
                    </div>
                    <div class="mt-2">
                        <div class="flex space-x-2">
                            <input type="text" id="modal-question-input" 
                                   placeholder="Add a question that came to mind..." 
                                   class="flex-1 text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400"
                                   onkeypress="if(event.key==='Enter') addQuestionFromModal()">
                            <button onclick="addQuestionFromModal()" 
                                    class="bg-blue-600 hover:bg-blue-700 dark:bg-blue-700 dark:hover:bg-blue-600 text-white px-3 py-2 rounded text-sm transition-colors">
                                Add
                            </button>
                        </div>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Attachment</label>
                    
                    <!-- Current attachment display -->
                    <div id="current-attachment" class="hidden mb-3 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <i data-lucide="paperclip" class="w-4 h-4 text-gray-500 dark:text-gray-400"></i>
                                <span id="attachment-name" class="text-sm text-gray-700 dark:text-gray-300"></span>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="previewAttachment()" 
                                        class="text-purple-600 hover:text-purple-800 dark:text-purple-400 dark:hover:text-purple-300 text-sm">
                                    <i data-lucide="eye" class="w-4 h-4"></i>
                                </button>
                                <button onclick="downloadAttachment()" 
                                        class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 text-sm">
                                    <i data-lucide="download" class="w-4 h-4"></i>
                                </button>
                                <button onclick="removeAttachment()" 
                                        class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 text-sm">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- File upload input -->
                    <div id="file-upload-section">
                        <input type="file" id="attachment-input" 
                               class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 dark:file:bg-blue-900 dark:file:text-blue-300"
                               accept="*/*">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Attach any file (documents, images, etc.)</p>
                    </div>
                </div>
                
                <div class="flex space-x-3">
                    <button onclick="saveTopicChanges()" 
                            class="flex-1 bg-blue-600 hover:bg-blue-700 dark:bg-blue-700 dark:hover:bg-blue-600 text-white py-2 rounded-lg transition-colors">
                        Save Changes
                    </button>
                    <button onclick="closeModal()" 
                            class="flex-1 bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-700 dark:text-gray-200 py-2 rounded-lg transition-colors">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTopics = [];
        let currentTopicId = null;
        let isGridView = false;

        // Session management variables
        let sessionStartTime = null;
        let sessionInterval = null;
        let currentSessionMinutes = 0;
        let currentCalendarDate = new Date();
        let currentTimeTrackingCalendarDate = new Date(); // Dedicated for time tracking
        let learningData = [];

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing...');
            
            try {
                lucide.createIcons();
                console.log('Lucide icons created');
                
                loadTopics();
                console.log('Loading topics...');
                
                loadProgress();
                console.log('Loading progress...');
                
                // Initialize time tracking system
                initializeTimeTracking();
                console.log('Time tracking initialized...');
                
                // Initialize simple learning time tracking
                initializeLearningTimeTracking();
                console.log('Learning time tracking initialized...');
                
                // Add longer delay and error handling for new endpoints
                setTimeout(async () => {
                    console.log('Loading calendar and session status...');
                    
                    try {
                        await loadTimeTrackingCalendar();
                        console.log('Time tracking calendar loaded successfully');
                    } catch (error) {
                        console.error('Time tracking calendar loading failed:', error);
                    }
                    
                    try {
                        await checkSessionStatus();
                        console.log('Session status checked successfully');
                    } catch (error) {
                        console.error('Session status check failed:', error);
                    }
                }, 2000);
                
                // Add theme toggle event listener
                document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
                console.log('Theme toggle listener added');
                
                // Add fullscreen toggle event listener
                document.getElementById('fullscreen-toggle').addEventListener('click', toggleFullscreen);
                console.log('Fullscreen toggle listener added');
                
                // Force refresh the total display after all initialization
                setTimeout(async () => {
                    try {
                        await updateTotalLearningTimeDisplay();
                        
                        // Also reset all timer displays to ensure clean state
                        const learningTimerDisplay = document.getElementById('learning-timer-display');
                        const sessionTimer = document.getElementById('session-timer');
                        
                        if (learningTimerDisplay) {
                            learningTimerDisplay.textContent = '00:00:00';
                            console.log('Reset learning-timer-display to 00:00:00');
                        }
                        
                        if (sessionTimer) {
                            sessionTimer.textContent = '00:00';
                            console.log('Reset session-timer to 00:00');
                        }
                        
                        console.log('Final display refresh completed');
                    } catch (error) {
                        console.error('Error in final display refresh:', error);
                    }
                }, 3000);
                
                // Restore fullscreen state if it was previously enabled
                const savedFullscreenState = localStorage.getItem('fullscreenMode');
                if (savedFullscreenState === 'true') {
                    setTimeout(() => {
                        enterFullscreen();
                    }, 500);
                }
                
                console.log('Initialization completed successfully');
            } catch (error) {
                console.error('Initialization error:', error);
            }
        });

        // Session management functions
        async function startLearningSession() {
            console.log('startLearningSession called');
            
            try {
                console.log('Making fetch request to /api/session/start');
                const response = await fetch('/api/session/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Response received:', response.status, response.ok);
                
                if (!response.ok) {
                    console.error('Start session request failed:', response.status, response.statusText);
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    showErrorMessage('Failed to start session: ' + response.statusText);
                    return;
                }
                
                const result = await response.json();
                console.log('Session start result:', result);
                
                sessionStartTime = new Date();
                currentSessionMinutes = 0;
                
                // Update UI
                const startBtn = document.getElementById('start-session-btn');
                const terminateBtn = document.getElementById('terminate-session-btn');
                
                if (startBtn && terminateBtn) {
                    startBtn.classList.add('hidden');
                    terminateBtn.classList.remove('hidden');
                    console.log('UI updated successfully');
                } else {
                    console.error('Session buttons not found in DOM');
                }
                
                // Start timer
                sessionInterval = setInterval(updateSessionTimer, 1000);
                console.log('Timer started');
                
                showSuccessMessage('Learning session started! Timer is now active.');
            } catch (error) {
                console.error('Error starting session:', error);
                showErrorMessage('Error starting session: ' + error.message);
            }
        }

        function updateSessionTimer() {
            if (!sessionStartTime) return;
            
            const now = new Date();
            const elapsedMs = now - sessionStartTime;
            const elapsedMinutes = Math.floor(elapsedMs / 60000);
            const elapsedSeconds = Math.floor((elapsedMs % 60000) / 1000);
            
            currentSessionMinutes = elapsedMinutes;
            
            // Update timer display - fix the format calculation
            const timerDisplay = document.getElementById('session-timer');
            const hours = Math.floor(elapsedMinutes / 60);
            const minutes = elapsedMinutes % 60;
            timerDisplay.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(elapsedSeconds).padStart(2, '0')}`;
            
            // Check if 1 hour (60 minutes) has passed - but only check at the exact minute
            // Also add a flag to prevent multiple triggers
            if (elapsedMinutes >= 60 && elapsedSeconds === 0 && !window.sessionModalShown) {
                window.sessionModalShown = true;
                showSessionCompletionModal();
            }
        }

        function showSessionCompletionModal() {
            clearInterval(sessionInterval);
            document.getElementById('session-modal').classList.remove('hidden');
        }

        async function continueSession() {
            try {
                const response = await fetch('/api/session/continue', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ elapsed_minutes: currentSessionMinutes })
                });
                
                if (response.ok) {
                    // Reset session timer but keep UI active
                    sessionStartTime = new Date();
                    sessionInterval = setInterval(updateSessionTimer, 1000);
                    
                    // Close modal
                    document.getElementById('session-modal').classList.add('hidden');
                    
                    // Record the completed hour and update calendar
                    await recordLearningSession(60, true);
                    await loadTimeTrackingCalendar();
                    
                    showSuccessMessage('Session continued! Starting new hour...');
                } else {
                    showErrorMessage('Failed to continue session');
                }
            } catch (error) {
                console.error('Error continuing session:', error);
                showErrorMessage('Error continuing session');
            }
        }

        async function closeApp() {
            try {
                // Record the completed session
                await recordLearningSession(currentSessionMinutes, true);
                
                const response = await fetch('/api/shutdown', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ elapsed_minutes: currentSessionMinutes })
                });
                
                if (response.ok) {
                    showSuccessMessage('Data saved. Please close this tab to exit.');
                } else {
                    showErrorMessage('Error shutting down');
                }
            } catch (error) {
                console.error('Error shutting down:', error);
                showErrorMessage('Error shutting down');
            }
        }

        async function terminateSession() {
            if (!confirm('Are you sure you want to terminate the session? This will save your progress and shut down the app.')) {
                return;
            }
            
            // Clear both timer systems
            clearInterval(sessionInterval);
            stopLearningTimerDisplay();
            
            // Reset states
            sessionStartTime = null;
            sessionInterval = null;
            currentLearningSessionId = null;
            learningStartTime = null;
            isLearningInProgress = false;
            
            // Reset UI
            const startBtn = document.getElementById('start-session-btn');
            const terminateBtn = document.getElementById('terminate-session-btn');
            if (startBtn) startBtn.classList.remove('hidden');
            if (terminateBtn) terminateBtn.classList.add('hidden');
            document.getElementById('session-timer').textContent = '00:00:00';
            
            const btn = document.getElementById('learning-control-btn');
            btn.innerHTML = '<i data-lucide="play" class="w-5 h-5 inline mr-2"></i>Start Learning';
            btn.className = 'bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg text-lg font-semibold transition-colors';
            
            try {
                await recordLearningSession(currentSessionMinutes, false);
                
                const response = await fetch('/api/shutdown', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ elapsed_minutes: currentSessionMinutes })
                });
                
                if (response.ok) {
                    showSuccessMessage('Session terminated. Data saved. Please close this tab to exit.');
                } else {
                    showErrorMessage('Error terminating session');
                }
            } catch (error) {
                console.error('Error terminating session:', error);
                showErrorMessage('Error terminating session');
            }
        }

        // Clear today's learning data
        async function clearTodayData() {
            if (!confirm('Are you sure you want to clear all learning data for today? This cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/time-tracking/clear-today', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: 'default_user'
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Today\'s data cleared:', result);
                    
                    // Reset any active session first
                    if (isLearningInProgress) {
                        clearInterval(sessionInterval);
                        stopLearningTimerDisplay();
                        
                        // Reset states
                        sessionStartTime = null;
                        sessionInterval = null;
                        currentLearningSessionId = null;
                        learningStartTime = null;
                        isLearningInProgress = false;
                        
                        // Reset UI
                        const startBtn = document.getElementById('start-session-btn');
                        const terminateBtn = document.getElementById('terminate-session-btn');
                        if (startBtn) startBtn.classList.remove('hidden');
                        if (terminateBtn) terminateBtn.classList.add('hidden');
                        document.getElementById('session-timer').textContent = '00:00:00';
                        
                        const btn = document.getElementById('learning-control-btn');
                        btn.innerHTML = '<i data-lucide="play" class="w-5 h-5 inline mr-2"></i>Start Learning';
                        btn.className = 'bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg text-lg font-semibold transition-colors';
                    }
                    
                    // Refresh displays
                    await updateTotalLearningTimeDisplay();
                    await loadTimeTrackingCalendar();
                    
                    showSuccessMessage(`Cleared ${result.deletedSessions} session(s) from today. Total time reset.`);
                } else {
                    const error = await response.json();
                    showErrorMessage('Error clearing today\'s data: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error clearing today\'s data:', error);
                showErrorMessage('Error clearing today\'s data');
            }
        }

        // Manual function to reset all timer displays (can be called from console)
        function resetAllTimerDisplays() {
            console.log('Manually resetting all timer displays...');
            
            // Reset main learning timer display
            const learningTimerDisplay = document.getElementById('learning-timer-display');
            if (learningTimerDisplay) {
                learningTimerDisplay.textContent = '00:00:00';
                learningTimerDisplay.innerHTML = '00:00:00'; // Force innerHTML update too
                console.log('Reset learning-timer-display to 00:00:00');
                console.log('Current learning-timer-display value:', learningTimerDisplay.textContent);
            }
            
            // Reset session timer in header
            const sessionTimer = document.getElementById('session-timer');
            if (sessionTimer) {
                sessionTimer.textContent = '00:00';
                sessionTimer.innerHTML = '00:00'; // Force innerHTML update too
                console.log('Reset session-timer to 00:00');
                console.log('Current session-timer value:', sessionTimer.textContent);
            }
            
            // Reset total time display
            const totalTimeDisplay = document.getElementById('total-time-display');
            if (totalTimeDisplay) {
                totalTimeDisplay.textContent = 'Total: 0h 0m';
                totalTimeDisplay.innerHTML = 'Total: 0h 0m'; // Force innerHTML update too
                console.log('Reset total-time-display to Total: 0h 0m');
                console.log('Current total-time-display value:', totalTimeDisplay.textContent);
            }
            
            // Update total time display from API
            updateTotalLearningTimeDisplay().then(() => {
                console.log('Total time display refreshed from API');
            });
            
            console.log('All timer displays reset complete');
            
            // Force a visual refresh by hiding and showing elements
            setTimeout(() => {
                [learningTimerDisplay, sessionTimer, totalTimeDisplay].forEach(element => {
                    if (element) {
                        element.style.visibility = 'hidden';
                        setTimeout(() => {
                            element.style.visibility = 'visible';
                        }, 50);
                    }
                });
                console.log('Forced visual refresh completed');
            }, 100);
        }

        async function recordLearningSession(minutes, completedSession) {
            try {
                const response = await fetch('/api/session/end', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        elapsed_minutes: minutes,
                        completed_session: completedSession
                    })
                });
                
                if (response.ok) {
                    console.log('Session recorded successfully');
                } else {
                    console.error('Failed to record session');
                }
            } catch (error) {
                console.error('Error recording session:', error);
            }
        }

        async function checkSessionStatus() {
            try {
                const response = await fetch('/api/session/status');
                
                if (!response.ok) {
                    console.error('Session status request failed:', response.status, response.statusText);
                    return;
                }
                
                const sessionData = await response.json();
                console.log('Session status data:', sessionData);
                
                if (sessionData.isActive) {
                    // Calculate elapsed time
                    const sessionStartTime_stored = new Date(sessionData.startTime);
                    const now = new Date();
                    const elapsedMs = now - sessionStartTime_stored;
                    const elapsedMinutes = Math.floor(elapsedMs / 60000);
                    
                    // Don't auto-resume sessions older than 5 minutes
                    // Ask user for confirmation instead
                    if (elapsedMinutes > 5) {
                        const shouldResume = confirm(`You have an active learning session from ${elapsedMinutes} minutes ago. Would you like to continue it?`);
                        
                        if (!shouldResume) {
                            // User declined, cancel the session without recording time
                            try {
                                await fetch('/api/session/cancel', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        sessionId: sessionData.sessionId
                                    })
                                });
                                console.log('Previous session cancelled by user');
                                
                                // Refresh the total learning time display after cancelling session
                                await updateTotalLearningTimeDisplay();
                                await loadTimeTrackingCalendar();
                                
                            } catch (error) {
                                console.error('Error cancelling previous session:', error);
                            }
                            return;
                        }
                    }
                    
                    // Resume session
                    // Set session variables for resuming (header timer system)
                    sessionStartTime = sessionStartTime_stored;
                    currentSessionMinutes = elapsedMinutes;
                    
                    // Set learning timer variables for resuming (main timer system)
                    currentLearningSessionId = sessionData.sessionId;
                    learningStartTime = sessionStartTime_stored;
                    isLearningInProgress = true;
                    
                    console.log('Resuming session. Elapsed minutes:', elapsedMinutes);
                    
                    // Update header UI
                    const startBtn = document.getElementById('start-session-btn');
                    const terminateBtn = document.getElementById('terminate-session-btn');
                    if (startBtn) startBtn.classList.add('hidden');
                    if (terminateBtn) terminateBtn.classList.remove('hidden');
                    
                    // Update main timer UI
                    const btn = document.getElementById('learning-control-btn');
                    btn.innerHTML = '<i data-lucide="square" class="w-5 h-5 inline mr-2"></i>Stop Learning';
                    btn.className = 'bg-red-600 hover:bg-red-700 text-white px-8 py-3 rounded-lg text-lg font-semibold transition-colors';
                    
                    // Start both timer systems
                    sessionInterval = setInterval(updateSessionTimer, 1000);
                    startLearningTimerDisplay();
                    
                    // Update timer displays immediately
                    updateSessionTimer();
                    
                    // Re-initialize lucide icons
                    setTimeout(() => lucide.createIcons(), 100);
                }
            } catch (error) {
                console.error('Error checking session status:', error);
                // Don't show error message on initial load, just log it
            }
        }

        // Calendar functions
        async function loadCalendar() {
            try {
                const response = await fetch('/api/calendar');
                
                if (!response.ok) {
                    console.error('Calendar request failed:', response.status, response.statusText);
                    return;
                }
                
                learningData = await response.json();
                renderCalendar();
            } catch (error) {
                console.error('Error loading calendar:', error);
                // Don't show error message on initial load, just log it
            }
        }

        function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            // Update month/year display
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('calendar-month-year').textContent = `${monthNames[month]} ${year}`;
            
            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            const calendarDays = document.getElementById('calendar-days');
            calendarDays.innerHTML = '';
            
            // Add empty cells for days before the first day of the month
            for (let i = 0; i < startingDayOfWeek; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'h-8';
                calendarDays.appendChild(emptyDay);
            }
            
            // Add days of the month
            const today = new Date();
            const todayString = today.toISOString().split('T')[0];
            
            // Set learning start date - only consider days from when learning tracking began
            // If there's learning data, use the earliest date, otherwise use today
            let learningStartDate = today;
            if (learningData.length > 0) {
                const earliestDate = new Date(Math.min(...learningData.map(d => new Date(d.date))));
                learningStartDate = earliestDate;
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                const dayDate = new Date(year, month, day);
                const dayString = dayDate.toISOString().split('T')[0];
                
                dayElement.className = 'h-8 flex items-center justify-center text-sm rounded cursor-pointer transition-colors';
                dayElement.textContent = day;
                
                // Find learning data for this day
                const dayData = learningData.find(d => d.date === dayString);
                
                if (dayString === todayString) {
                    // Today - special styling
                    dayElement.classList.add('ring-2', 'ring-blue-500', 'font-bold');
                }
                
                if (dayDate > today) {
                    // Future days - gray
                    dayElement.classList.add('bg-gray-200', 'dark:bg-gray-600', 'text-gray-500', 'dark:text-gray-400');
                } else if (dayData && dayData.minutes_learned >= 60) {
                    // Goal achieved - green
                    dayElement.classList.add('bg-green-500', 'text-white', 'font-medium');
                    dayElement.title = `${dayData.minutes_learned} minutes learned`;
                } else if (dayDate < today && dayDate >= learningStartDate) {
                    // Missed day (only for days after learning started) - red
                    dayElement.classList.add('bg-red-500', 'text-white');
                    dayElement.title = dayData ? `${dayData.minutes_learned} minutes learned (missed goal)` : 'No learning recorded';
                } else if (dayString === todayString) {
                    // Today but no goal achieved yet - yellow
                    dayElement.classList.add('bg-yellow-200', 'dark:bg-yellow-600', 'text-yellow-800', 'dark:text-yellow-200');
                    dayElement.title = dayData ? `${dayData.minutes_learned} minutes learned so far` : 'No learning yet today';
                } else {
                    // Days before learning started - neutral gray
                    dayElement.classList.add('bg-gray-100', 'dark:bg-gray-700', 'text-gray-400', 'dark:text-gray-500');
                    dayElement.title = 'Before learning tracking started';
                }
                
                calendarDays.appendChild(dayElement);
            }
        }

        function changeCalendarMonth(delta) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
            renderCalendar();
        }

        // Load topics from server
        async function loadTopics() {
            try {
                const response = await fetch('/api/topics');
                const topics = await response.json();
                currentTopics = topics;
                
                if (topics.length === 0) {
                    document.getElementById('empty-state').classList.remove('hidden');
                    document.getElementById('topics-container').innerHTML = '';
                } else {
                    document.getElementById('empty-state').classList.add('hidden');
                    renderTopics(topics);
                }
            } catch (error) {
                console.error('Error loading topics:', error);
            }
        }

        // Render topics in the current view
        function renderTopics(topics) {
            const container = document.getElementById('topics-container');
            
            if (isGridView) {
                renderGridView(topics, container);
            } else {
                renderModuleView(topics, container);
            }
            
            lucide.createIcons();
        }

        // Render topics grouped by modules
        function renderModuleView(topics, container) {
            const moduleGroups = groupTopicsByModule(topics);
            
            container.innerHTML = Object.keys(moduleGroups).map(module => {
                const moduleTopics = moduleGroups[module];
                const completedCount = moduleTopics.filter(t => t.status === 'completed').length;
                const totalCount = moduleTopics.length;
                const progressPercent = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
                
                return `
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 mb-6">
                        <div class="p-6 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-700/50">
                            <div class="flex justify-between items-center">
                                <h3 class="text-xl font-bold text-gray-800 dark:text-gray-200 uppercase tracking-wide">${module}</h3>
                                <div class="flex items-center space-x-4">
                                    <span class="text-sm text-gray-600 dark:text-gray-400 font-medium">${completedCount}/${totalCount} completed</span>
                                    <div class="w-24 bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                                        <div class="bg-green-500 dark:bg-green-400 h-2 rounded-full transition-all duration-300" style="width: ${progressPercent}%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="p-6">
                            <div class="space-y-4">
                                ${moduleTopics.map(topic => renderStructuredTopic(topic)).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Function to render a topic with structured description display
        function renderStructuredTopic(topic) {
            const parsedContent = parseTopicDescription(topic.description);
            const topicId = `topic-${topic.id}`;
            
            return `
                <div class="topic-card border border-gray-200 dark:border-gray-600 rounded-lg overflow-hidden bg-gray-50 dark:bg-gray-700/30" data-topic-id="${topic.id}">
                                        <div class="flex items-center justify-between p-4 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-600 cursor-pointer" onclick="toggleTopicDetails('${topicId}')">
                        <div class="flex items-center space-x-3">
                            <div class="w-6 h-6 rounded-full flex items-center justify-center ${getStatusIcon(topic.status)}">
                                <i data-lucide="${getStatusIconName(topic.status)}" class="w-4 h-4"></i>
                            </div>
                            <h4 class="font-medium text-gray-900 dark:text-white">${topic.title}</h4>
                            ${topic.questions && topic.questions.length > 0 ? `
                                <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300">
                                    <i data-lucide="help-circle" class="w-3 h-3 mr-1"></i>
                                    ${topic.questions.length} ${topic.questions.length === 1 ? 'question' : 'questions'}
                                </span>
                            ` : ''}
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${getStatusBadge(topic.status)}">
                                ${getStatusText(topic.status)}
                            </span>
                            ${topic.attachment_original_name ? `
                                <button onclick="event.stopPropagation(); previewTopicAttachment(${topic.id})" 
                                        class="text-purple-600 hover:text-purple-800 dark:text-purple-400 dark:hover:text-purple-300 p-1"
                                        title="Preview ${topic.attachment_original_name}">
                                    <i data-lucide="eye" class="w-4 h-4"></i>
                                </button>
                            ` : ''}
                            <button onclick="event.stopPropagation(); openTopicModal(${topic.id})" 
                                    class="text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300 p-1">
                                <i data-lucide="edit-3" class="w-4 h-4"></i>
                            </button>
                            <i data-lucide="chevron-down" class="w-5 h-5 text-gray-400 dark:text-gray-500 transform transition-transform topic-chevron"></i>
                        </div>
                    </div>
                    
                    <div id="${topicId}" class="topic-details hidden p-4 space-y-4 bg-gray-50 dark:bg-gray-800/50">
                        ${parsedContent.descriptions.length > 0 ? `
                            <div>
                                <h5 class="font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wide text-sm mb-2">DESCRIPTION</h5>
                                <ul class="space-y-1 text-sm text-gray-600 dark:text-gray-400">
                                    ${parsedContent.descriptions.map(desc => `<li class="flex items-start"><span class="mr-2 text-gray-400 dark:text-gray-500"></span><span>${desc}</span></li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        ${parsedContent.artifacts.length > 0 ? `
                            <div>
                                <h5 class="font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wide text-sm mb-2">ARTIFACTS</h5>
                                <ul class="space-y-1 text-sm text-gray-600 dark:text-gray-400">
                                    ${parsedContent.artifacts.map(artifact => `<li class="flex items-start"><span class="mr-2 text-gray-400 dark:text-gray-500"></span><span>${artifact}</span></li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        ${parsedContent.other.length > 0 ? `
                            <div>
                                <h5 class="font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wide text-sm mb-2">ADDITIONAL INFO</h5>
                                <ul class="space-y-1 text-sm text-gray-600 dark:text-gray-400">
                                    ${parsedContent.other.map(info => `<li class="flex items-start"><span class="mr-2 text-gray-400 dark:text-gray-500"></span><span>${info}</span></li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        ${topic.notes ? `
                            <div>
                                <h5 class="font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wide text-sm mb-2">NOTES</h5>
                                <p class="text-sm text-gray-600 dark:text-gray-400">${topic.notes}</p>
                            </div>
                        ` : ''}
                        
                        <!-- Questions Section -->
                        <div class="border-t border-gray-200 dark:border-gray-600 pt-4">
                            <div class="flex items-center justify-between mb-2">
                                <h5 class="font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wide text-sm">QUESTIONS & RESEARCH</h5>
                                <button onclick="event.stopPropagation(); toggleQuestionInput('questions-${topic.id}')" 
                                        class="text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 text-xs">
                                    <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i>Add Question
                                </button>
                            </div>
                            
                            <!-- Questions List -->
                            <div id="questions-list-${topic.id}" class="space-y-2 mb-3">
                                ${topic.questions ? topic.questions.map((question, index) => `
                                    <div class="question-item ${question.answered ? 'question-answered' : ''} bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-3 group">
                                        <div class="flex items-start justify-between">
                                            <p class="question-text text-sm text-yellow-800 dark:text-yellow-200 flex-1">${question.text}</p>
                                            <div class="flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity ml-2">
                                                ${question.answered ? `
                                                    <button onclick="event.stopPropagation(); toggleQuestionStatus(${topic.id}, ${index})" 
                                                            class="text-green-600 hover:text-green-700 dark:text-green-400" title="Mark as unanswered">
                                                        <i data-lucide="check-circle" class="w-4 h-4"></i>
                                                    </button>
                                                ` : `
                                                    <button onclick="event.stopPropagation(); toggleQuestionStatus(${topic.id}, ${index})" 
                                                            class="text-gray-400 hover:text-green-600 dark:text-gray-500 dark:hover:text-green-400" title="Mark as answered">
                                                        <i data-lucide="circle" class="w-4 h-4"></i>
                                                    </button>
                                                `}
                                                <button onclick="event.stopPropagation(); removeQuestion(${topic.id}, ${index})" 
                                                        class="text-red-400 hover:text-red-600 dark:text-red-500 dark:hover:text-red-400" title="Delete question">
                                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                </button>
                                            </div>
                                        </div>
                                        ${question.answered ? `
                                            <div class="mt-2 flex items-center text-xs text-green-600 dark:text-green-400">
                                                <i data-lucide="check" class="w-3 h-3 mr-1"></i>
                                                Answered
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('') : ''}
                                ${!topic.questions || topic.questions.length === 0 ? `
                                    <p class="text-xs text-gray-500 dark:text-gray-400 italic">No questions yet. Click "Add Question" to start tracking your learning questions.</p>
                                ` : ''}
                            </div>
                            
                            <!-- Add Question Input (Hidden by default) -->
                            <div id="questions-${topic.id}" class="hidden">
                                <div class="flex space-x-2">
                                    <input type="text" id="question-input-${topic.id}" 
                                           placeholder="What question came to mind while learning this?" 
                                           class="flex-1 text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400"
                                           onkeypress="if(event.key==='Enter') addQuestion(${topic.id})">
                                    <button onclick="addQuestion(${topic.id})" 
                                            class="bg-blue-600 hover:bg-blue-700 dark:bg-blue-700 dark:hover:bg-blue-600 text-white px-3 py-2 rounded text-sm transition-colors">
                                        Add
                                    </button>
                                    <button onclick="toggleQuestionInput('questions-${topic.id}')" 
                                            class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-700 dark:text-gray-200 px-3 py-2 rounded text-sm transition-colors">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Function to parse topic description into structured content
        function parseTopicDescription(description) {
            if (!description) return { descriptions: [], artifacts: [], other: [] };
            
            const result = { descriptions: [], artifacts: [], other: [] };
            const sections = description.split(/\*\*(.*?)\*\*/);
            
            let currentSection = 'descriptions';
            let currentContent = '';
            
            for (let i = 0; i < sections.length; i++) {
                const section = sections[i].trim();
                
                if (section.toLowerCase().includes('description')) {
                    currentSection = 'descriptions';
                } else if (section.toLowerCase().includes('artifact')) {
                    currentSection = 'artifacts';
                } else if (section.toLowerCase().includes('nebo') || section.toLowerCase().includes('outcome') || 
                          section.toLowerCase().includes('learning') || section.toLowerCase().includes('additional')) {
                    currentSection = 'other';
                } else if (section.length > 0) {
                    // This is content, split by bullet points or newlines
                    const items = section.split(/\n|\n/).filter(item => item.trim().length > 0);
                    items.forEach(item => {
                        const cleanItem = item.replace(/^\s*/, '').trim();
                        if (cleanItem) {
                            result[currentSection].push(cleanItem);
                        }
                    });
                }
            }
            
            return result;
        }

        // Function to toggle topic details visibility
        function toggleTopicDetails(topicId) {
            const detailsElement = document.getElementById(topicId);
            const chevron = detailsElement.previousElementSibling.querySelector('.topic-chevron');
            
            if (detailsElement.classList.contains('hidden')) {
                detailsElement.classList.remove('hidden');
                chevron.style.transform = 'rotate(180deg)';
            } else {
                detailsElement.classList.add('hidden');
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        // Render topics in grid view
        function renderGridView(topics, container) {
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${topics.map(topic => `
                        <div class="topic-card bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 cursor-pointer status-${topic.status}" 
                             onclick="openTopicModal(${topic.id})">
                            <div class="flex items-start justify-between mb-3">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center ${getStatusIcon(topic.status)}">
                                    <i data-lucide="${getStatusIconName(topic.status)}" class="w-5 h-5"></i>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="px-2 py-1 text-xs font-medium rounded-full ${getStatusBadge(topic.status)}">
                                        ${getStatusText(topic.status)}
                                    </span>
                                    ${topic.attachment_original_name ? `
                                        <button onclick="event.stopPropagation(); previewTopicAttachment(${topic.id})" 
                                                class="text-purple-600 hover:text-purple-800 dark:text-purple-400 dark:hover:text-purple-300 p-1"
                                                title="Preview ${topic.attachment_original_name}">
                                            <i data-lucide="eye" class="w-4 h-4"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                            <h4 class="font-semibold text-gray-900 dark:text-white mb-2">${topic.title}</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-3 line-clamp-3">${(topic.description || '').substring(0, 100)}${topic.description && topic.description.length > 100 ? '...' : ''}</p>
                            <div class="flex items-center justify-between text-xs text-gray-500 dark:text-gray-400">
                                <span>${topic.module || 'Uncategorized'}</span>
                                <div class="flex items-center space-x-2">
                                    ${topic.questions && topic.questions.length > 0 ? `
                                        <div class="flex items-center space-x-1" title="${topic.questions.length} question(s)">
                                            <i data-lucide="help-circle" class="w-3 h-3"></i>
                                            <span>${topic.questions.length}</span>
                                        </div>
                                    ` : ''}
                                    ${topic.notes ? '<i data-lucide="sticky-note" class="w-4 h-4"></i>' : ''}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Helper functions for UI
        function groupTopicsByModule(topics) {
            return topics.reduce((groups, topic) => {
                const module = topic.module || 'Uncategorized';
                if (!groups[module]) groups[module] = [];
                groups[module].push(topic);
                return groups;
            }, {});
        }

        function getStatusIcon(status) {
            const icons = {
                'not-started': 'bg-gray-200 text-gray-600',
                'in-progress': 'bg-yellow-200 text-yellow-600',
                'completed': 'bg-green-200 text-green-600'
            };
            return icons[status] || icons['not-started'];
        }

        function getStatusIconName(status) {
            const icons = {
                'not-started': 'circle',
                'in-progress': 'clock',
                'completed': 'check'
            };
            return icons[status] || 'circle';
        }

        function getStatusBadge(status) {
            const badges = {
                'not-started': 'bg-gray-100 text-gray-700',
                'in-progress': 'bg-yellow-100 text-yellow-700',
                'completed': 'bg-green-100 text-green-700'
            };
            return badges[status] || badges['not-started'];
        }

        function getStatusText(status) {
            const texts = {
                'not-started': 'Not Started',
                'in-progress': 'In Progress',
                'completed': 'Completed'
            };
            return texts[status] || 'Not Started';
        }

        // Modal functions
        function openTopicModal(topicId) {
            const topic = currentTopics.find(t => t.id === topicId);
            if (!topic) return;
            
            currentTopicId = topicId;
            document.getElementById('modal-title').textContent = topic.title;
            document.getElementById('modal-status').value = topic.status;
            document.getElementById('modal-notes').value = topic.notes || '';
            
            // Populate questions in modal
            populateModalQuestions(topic.questions || []);
            
            // Handle attachment display
            const currentAttachment = document.getElementById('current-attachment');
            const attachmentName = document.getElementById('attachment-name');
            const fileUploadSection = document.getElementById('file-upload-section');
            const attachmentInput = document.getElementById('attachment-input');
            
            if (topic.attachment_original_name) {
                // Show current attachment
                currentAttachment.classList.remove('hidden');
                attachmentName.textContent = topic.attachment_original_name;
                fileUploadSection.style.display = 'none';
            } else {
                // Hide current attachment, show upload section
                currentAttachment.classList.add('hidden');
                fileUploadSection.style.display = 'block';
                attachmentInput.value = ''; // Clear any previous selection
            }
            
            document.getElementById('topic-modal').classList.remove('hidden');
        }

        function populateModalQuestions(questions) {
            const container = document.getElementById('modal-questions-list');
            
            if (questions.length === 0) {
                container.innerHTML = '<p class="text-xs text-gray-500 dark:text-gray-400 italic">No questions yet.</p>';
                return;
            }
            
            container.innerHTML = questions.map((question, index) => `
                <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-2 group">
                    <div class="flex items-start justify-between">
                        <p class="text-sm text-yellow-800 dark:text-yellow-200 flex-1">${question.text}</p>
                        <div class="flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity ml-2">
                            ${question.answered ? `
                                <button onclick="toggleQuestionStatus(${currentTopicId}, ${index})" 
                                        class="text-green-600 hover:text-green-700 dark:text-green-400" title="Mark as unanswered">
                                    <i data-lucide="check-circle" class="w-3 h-3"></i>
                                </button>
                            ` : `
                                <button onclick="toggleQuestionStatus(${currentTopicId}, ${index})" 
                                        class="text-gray-400 hover:text-green-600 dark:text-gray-500 dark:hover:text-green-400" title="Mark as answered">
                                    <i data-lucide="circle" class="w-3 h-3"></i>
                                </button>
                            `}
                            <button onclick="removeQuestionFromModal(${index})" 
                                    class="text-red-400 hover:text-red-600 dark:text-red-500 dark:hover:text-red-400" title="Delete question">
                                <i data-lucide="trash-2" class="w-3 h-3"></i>
                            </button>
                        </div>
                    </div>
                    ${question.answered ? `
                        <div class="mt-1 flex items-center text-xs text-green-600 dark:text-green-400">
                            <i data-lucide="check" class="w-3 h-3 mr-1"></i>
                            Answered
                        </div>
                    ` : ''}
                </div>
            `).join('');
            
            // Re-initialize lucide icons
            setTimeout(() => lucide.createIcons(), 100);
        }

        async function addQuestionFromModal() {
            if (!currentTopicId) return;
            
            const input = document.getElementById('modal-question-input');
            const questionText = input.value.trim();
            
            if (!questionText) return;
            
            try {
                const response = await fetch(`/api/topics/${currentTopicId}/questions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ text: questionText })
                });
                
                if (response.ok) {
                    input.value = '';
                    // Refresh the topic data and update modal
                    const updatedTopicResponse = await fetch(`/api/topics/${currentTopicId}`);
                    const updatedTopic = await updatedTopicResponse.json();
                    populateModalQuestions(updatedTopic.questions || []);
                    
                    // Update currentTopics array
                    const topicIndex = currentTopics.findIndex(t => t.id === currentTopicId);
                    if (topicIndex !== -1) {
                        currentTopics[topicIndex] = updatedTopic;
                    }
                    
                    showSuccessMessage('Question added successfully!');
                } else {
                    showErrorMessage('Error adding question');
                }
            } catch (error) {
                console.error('Error adding question:', error);
                showErrorMessage('Error adding question');
            }
        }

        async function removeQuestionFromModal(questionIndex) {
            if (!currentTopicId || !confirm('Are you sure you want to delete this question?')) return;
            
            try {
                const response = await fetch(`/api/topics/${currentTopicId}/questions/${questionIndex}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    // Refresh the topic data and update modal
                    const updatedTopicResponse = await fetch(`/api/topics/${currentTopicId}`);
                    const updatedTopic = await updatedTopicResponse.json();
                    populateModalQuestions(updatedTopic.questions || []);
                    
                    // Update currentTopics array
                    const topicIndex = currentTopics.findIndex(t => t.id === currentTopicId);
                    if (topicIndex !== -1) {
                        currentTopics[topicIndex] = updatedTopic;
                    }
                    
                    showSuccessMessage('Question deleted successfully!');
                } else {
                    showErrorMessage('Error deleting question');
                }
            } catch (error) {
                console.error('Error deleting question:', error);
                showErrorMessage('Error deleting question');
            }
        }

        function closeModal() {
            document.getElementById('topic-modal').classList.add('hidden');
            document.getElementById('modal-question-input').value = '';
            currentTopicId = null;
        }

        async function saveTopicChanges() {
            if (!currentTopicId) {
                console.error('No current topic ID');
                return;
            }
            
            const status = document.getElementById('modal-status').value;
            const notes = document.getElementById('modal-notes').value;
            const attachmentInput = document.getElementById('attachment-input');
            
            try {
                // First, save the topic status and notes
                const topicResponse = await fetch(`/api/topics/${currentTopicId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status, notes })
                });
                
                if (!topicResponse.ok) {
                    throw new Error('Failed to update topic');
                }
                
                // If there's a file selected, upload it
                if (attachmentInput && attachmentInput.files && attachmentInput.files.length > 0) {
                    const formData = new FormData();
                    formData.append('attachment', attachmentInput.files[0]);
                    
                    const attachmentResponse = await fetch(`/api/topics/${currentTopicId}/attachment`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!attachmentResponse.ok) {
                        const errorData = await attachmentResponse.json();
                        throw new Error('Failed to upload attachment: ' + (errorData.error || 'Unknown error'));
                    }
                    
                    console.log('File attached successfully');
                }
                
                closeModal();
                loadTopics(); // Refresh the topics to show the attachment status
                loadProgress();
                
                // Show achievement if completed
                if (status === 'completed') {
                    checkForNewAchievements();
                }
            } catch (error) {
                console.error('Error updating topic:', error);
                showErrorMessage('Error updating topic: ' + error.message);
            }
        }

        // Attachment functions
        async function removeAttachment() {
            if (!currentTopicId) {
                console.error('No current topic ID set');
                return;
            }
            
            if (!confirm('Are you sure you want to remove this attachment?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/topics/${currentTopicId}/attachment`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    // Hide the current attachment display
                    document.getElementById('current-attachment').classList.add('hidden');
                    // Show the file upload section
                    document.getElementById('file-upload-section').style.display = 'block';
                    // Clear the file input
                    document.getElementById('attachment-input').value = '';
                    
                    showSuccessMessage('Attachment removed successfully');
                    loadTopics(); // Refresh the topics to update the attachment status
                } else {
                    const errorData = await response.json();
                    showErrorMessage('Error removing attachment: ' + (errorData.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error removing attachment:', error);
                showErrorMessage('Error removing attachment');
            }
        }

        async function downloadAttachment() {
            if (!currentTopicId) {
                console.error('No current topic ID set');
                return;
            }
            
            try {
                window.open(`/api/topics/${currentTopicId}/attachment/download`, '_blank');
            } catch (error) {
                console.error('Error downloading attachment:', error);
                showErrorMessage('Error downloading attachment');
            }
        }

        // Function to preview attachment
        async function previewAttachment() {
            console.log('Preview attachment called for topic ID:', currentTopicId);
            
            if (!currentTopicId) {
                console.error('No current topic ID set');
                showErrorMessage('No topic selected for preview');
                return;
            }
            
            try {
                console.log('Fetching preview for topic:', currentTopicId);
                const response = await fetch(`/api/topics/${currentTopicId}/attachment/preview`);
                console.log('Preview response status:', response.status);
                
                if (response.ok) {
                    const previewData = await response.json();
                    console.log('Preview data received:', previewData);
                    showFilePreview(previewData);
                } else {
                    const errorData = await response.json();
                    console.error('Preview error response:', errorData);
                    if (errorData.canPreview === false) {
                        showErrorMessage('File preview not available: ' + errorData.error);
                    } else {
                        showErrorMessage('Error loading file preview: ' + (errorData.error || 'Unknown error'));
                    }
                }
            } catch (error) {
                console.error('Error previewing attachment:', error);
                showErrorMessage('Error loading file preview: ' + error.message);
            }
        }

        // Function to preview attachment directly from topic card (without modal being open)
        async function previewTopicAttachment(topicId) {
            console.log('Preview topic attachment called for topic ID:', topicId);
            
            if (!topicId) {
                console.error('No topic ID provided');
                showErrorMessage('No topic selected for preview');
                return;
            }
            
            try {
                console.log('Fetching preview for topic:', topicId);
                const response = await fetch(`/api/topics/${topicId}/attachment/preview`);
                console.log('Preview response status:', response.status);
                
                if (response.ok) {
                    const previewData = await response.json();
                    console.log('Preview data received:', previewData);
                    showFilePreview(previewData);
                } else {
                    const errorData = await response.json();
                    console.error('Preview error response:', errorData);
                    if (errorData.canPreview === false) {
                        showErrorMessage('File preview not available: ' + errorData.error);
                    } else {
                        showErrorMessage('Error loading file preview: ' + (errorData.error || 'Unknown error'));
                    }
                }
            } catch (error) {
                console.error('Error previewing topic attachment:', error);
                showErrorMessage('Error loading file preview: ' + error.message);
            }
        }

        // Function to detect if content is likely Markdown
        function isMarkdownContent(content, filename) {
            // Check file extension
            const markdownExtensions = ['md', 'markdown', 'mdown', 'mkd', 'mkdn'];
            const extension = filename.split('.').pop().toLowerCase();
            if (markdownExtensions.includes(extension)) {
                return true;
            }
            
            // Check for common Markdown patterns
            const markdownPatterns = [
                /^#{1,6}\s+.+$/m,              // Headers
                /^\*\*.*\*\*$/m,              // Bold text
                /^\*.*\*$/m,                  // Italic text
                /^-{3,}$/m,                   // Horizontal rule
                /^\|.*\|.*\|$/m,              // Tables
                /^>\s+.+$/m,                  // Blockquotes
                /^\* .+$/m,                   // Unordered lists
                /^\d+\. .+$/m,                // Ordered lists
                /```[\s\S]*```/,              // Code blocks
                /`[^`]+`/                     // Inline code
            ];
            
            // Count how many patterns match
            let matchCount = 0;
            for (const pattern of markdownPatterns) {
                if (pattern.test(content)) {
                    matchCount++;
                }
            }
            
            // If 3 or more patterns match, consider it Markdown
            return matchCount >= 3;
        }

        // Function to configure marked options
        function configureMarked() {
            if (typeof marked !== 'undefined') {
                marked.setOptions({
                    breaks: true,
                    gfm: true,
                    headerIds: false,
                    mangle: false
                });
            }
        }

        // Function to show file preview in modal
        function showFilePreview(previewData) {
            const modal = document.getElementById('file-preview-modal');
            const title = document.getElementById('file-preview-title');
            const content = document.getElementById('file-preview-content');

            title.textContent = `Preview: ${previewData.filename}`;

            // Add toggle for File Information visibility
            let showFileInfo = true;
            if (localStorage.getItem('hideFileInfo') === 'true') {
                showFileInfo = false;
            }

            function getFileInfoToggleHTML() {
                return `<label class="inline-flex items-center cursor-pointer ml-2">
                    <input type="checkbox" id="toggle-file-info" class="form-checkbox h-4 w-4 text-blue-600" ${showFileInfo ? '' : 'checked'}>
                    <span class="ml-2 text-xs text-gray-600 dark:text-gray-300">Hide File Information</span>
                </label>`;
            }

            function getFileInfoSection(html) {
                return `<div id="file-info-section" class="bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg p-4 mb-2">
                    <div class="flex items-center justify-between">
                        <h4 class="font-semibold text-gray-800 dark:text-gray-200 mb-2">File Information</h4>
                        ${getFileInfoToggleHTML()}
                    </div>
                    ${html}
                </div>`;
            }

            let fileInfoHTML = '';
            if (previewData.type === 'xlsx') {
                // Display XLSX preview
                const xlsxData = previewData.xlsxData;
                fileInfoHTML = `<p class="text-sm text-gray-600 dark:text-gray-400">
                    File Size: <strong>${formatFileSize(previewData.fileSize)}</strong> | 
                    Sheets: <strong>${xlsxData.totalSheets}</strong>
                </p>`;
                let fileInfoSection = showFileInfo ? getFileInfoSection(fileInfoHTML) : getFileInfoToggleHTML();
                content.innerHTML = `
                    <div class="space-y-4">
                        ${fileInfoSection}
                        <div>
                            <h4 class="font-medium text-gray-900 dark:text-gray-100 mb-3">Preview (First 3 sheets)</h4>
                            <div class="space-y-4">
                                ${xlsxData.sheetsPreview.map(sheet => `
                                    <div class="border border-gray-200 dark:border-gray-600 rounded-lg p-4">
                                        <h5 class="font-medium text-gray-800 dark:text-gray-200 mb-2">${sheet.sheetName}</h5>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                                            <div class="bg-blue-50 dark:bg-blue-900/20 rounded p-3">
                                                <p class="text-sm font-medium text-blue-900 dark:text-blue-300">Level (A1):</p>
                                                <p class="text-sm text-blue-700 dark:text-blue-400">${sheet.level}</p>
                                            </div>
                                            <div class="bg-green-50 dark:bg-green-900/20 rounded p-3">
                                                <p class="text-sm font-medium text-green-900 dark:text-green-300">Task Name (B1):</p>
                                                <p class="text-sm text-green-700 dark:text-green-400">${sheet.taskName}</p>
                                            </div>
                                        </div>
                                        ${sheet.error ? `<p class="text-red-600 text-sm">Error: ${sheet.error}</p>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Display text file preview
                const fileExtension = previewData.filename.split('.').pop().toLowerCase();
                const fileType = previewData.subType || 'text';
                // Check if content should be rendered as Markdown
                const isMarkdown = isMarkdownContent(previewData.content, previewData.filename);
                // Configure marked if available
                configureMarked();
                let contentDisplay = '';
                let contentTypeLabel = fileExtension.toUpperCase();
                if (isMarkdown && typeof marked !== 'undefined') {
                    // Render as Markdown
                    try {
                        const htmlContent = marked.parse(previewData.content);
                        contentDisplay = `
                            <div class="bg-white dark:bg-gray-800 preview-content-area">
                                <div class="markdown-content">${htmlContent}</div>
                            </div>
                        `;
                        contentTypeLabel += ' (Markdown)';
                    } catch (error) {
                        console.error('Error parsing Markdown:', error);
                        // Fallback to plain text
                        contentDisplay = `
                            <div class="bg-gray-50 dark:bg-gray-800 preview-content-area">
                                <pre class="text-sm text-gray-800 dark:text-gray-200 whitespace-pre-wrap font-mono leading-relaxed">${escapeHtml(previewData.content)}</pre>
                            </div>
                        `;
                    }
                } else {
                    // Display as plain text or code
                    let syntaxClass = '';
                    if (fileType === 'code') {
                        syntaxClass = 'language-' + fileExtension;
                    } else if (fileType === 'markdown') {
                        syntaxClass = 'language-markdown';
                    }
                    contentDisplay = `
                        <div class="bg-gray-50 dark:bg-gray-800 preview-content-area">
                            <pre><code class="text-sm text-gray-800 dark:text-gray-200 whitespace-pre-wrap font-mono leading-relaxed ${syntaxClass}">${escapeHtml(previewData.content)}</code></pre>
                        </div>
                    `;
                }
                fileInfoHTML = `<p class="text-sm text-gray-600 dark:text-gray-400">
                    File Type: <strong>${contentTypeLabel}</strong> | 
                    File Size: <strong>${formatFileSize(previewData.fileSize)}</strong>
                </p>
                ${isMarkdown ? `
                    <div class="mt-2 flex items-center space-x-2">
                        <span class="bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300 text-xs px-2 py-1 rounded">Rendered View</span>
                        <button onclick="toggleMarkdownView(this)" class="text-xs text-blue-600 dark:text-blue-400 hover:underline">Switch to Raw</button>
                    </div>
                ` : ''}`;
                let fileInfoSection = showFileInfo ? getFileInfoSection(fileInfoHTML) : getFileInfoToggleHTML();
                content.innerHTML = `
                    <div class="space-y-4">
                        ${fileInfoSection}
                        <div>
                            <h4 class="font-medium text-gray-900 dark:text-gray-100 mb-3">Content</h4>
                            <div id="content-display">
                                ${contentDisplay}
                            </div>
                            ${isMarkdown ? `
                                <div id="raw-content" class="hidden">
                                    <div class="bg-gray-50 dark:bg-gray-800 preview-content-area">
                                        <pre><code class="text-sm text-gray-800 dark:text-gray-200 whitespace-pre-wrap font-mono leading-relaxed language-markdown">${escapeHtml(previewData.content)}</code></pre>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            // Highlight code blocks if present
            setTimeout(() => {
                // Highlight all code blocks in preview
                if (window.hljs) {
                    document.querySelectorAll('#file-preview-content pre code').forEach((block) => {
                        window.hljs.highlightElement(block);
                    });
                }
                // Add event listener for the toggle
                const toggle = document.getElementById('toggle-file-info');
                if (toggle) {
                    toggle.addEventListener('change', function() {
                        const hide = this.checked;
                        localStorage.setItem('hideFileInfo', hide ? 'true' : 'false');
                        showFilePreview(previewData);
                    });
                }
            }, 0);

            modal.classList.remove('hidden');
            
            // Reset scroll position to top for better user experience
            const modalContent = modal.querySelector('.max-h-\\[80vh\\]');
            if (modalContent) {
                modalContent.scrollTop = 0;
            }
        }

        // Function to close file preview modal
        function closeFilePreview() {
            document.getElementById('file-preview-modal').classList.add('hidden');
        }

        // Function to toggle between Markdown rendered and raw view
        function toggleMarkdownView(button) {
            const contentDisplay = document.getElementById('content-display');
            const rawContent = document.getElementById('raw-content');
            
            if (contentDisplay && rawContent) {
                if (rawContent.classList.contains('hidden')) {
                    // Show raw content
                    contentDisplay.classList.add('hidden');
                    rawContent.classList.remove('hidden');
                    button.textContent = 'Switch to Rendered';
                    
                    // Update the badge
                    const badge = button.parentElement.querySelector('span');
                    if (badge) {
                        badge.textContent = 'Raw View';
                        badge.className = 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-300 text-xs px-2 py-1 rounded';
                    }
                } else {
                    // Show rendered content
                    contentDisplay.classList.remove('hidden');
                    rawContent.classList.add('hidden');
                    button.textContent = 'Switch to Raw';
                    
                    // Update the badge
                    const badge = button.parentElement.querySelector('span');
                    if (badge) {
                        badge.textContent = 'Rendered View';
                        badge.className = 'bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300 text-xs px-2 py-1 rounded';
                    }
                }
            }
        }

        // Function to toggle modal fullscreen
        function toggleModalFullscreen(modalId) {
            const modal = document.getElementById(modalId);
            const modalContent = modal.querySelector('.bg-white, .dark\\:bg-gray-800');
            const fullscreenButton = modal.querySelector('[onclick*="toggleModalFullscreen"]');
            const fullscreenIcon = fullscreenButton.querySelector('[data-lucide]');
            
            if (modal.classList.contains('modal-fullscreen')) {
                // Exit modal fullscreen
                modal.classList.remove('modal-fullscreen');
                modalContent.classList.remove('max-w-none', 'w-full', 'h-full', 'm-0');
                modalContent.classList.add('max-w-4xl', 'max-h-[80vh]');
                fullscreenIcon.setAttribute('data-lucide', 'maximize');
                fullscreenButton.title = 'Toggle fullscreen';
                
                // Reset content areas to original constraints
                const previewAreas = modal.querySelectorAll('.preview-content-area');
                previewAreas.forEach(area => {
                    area.style.maxHeight = '';
                    area.style.height = '';
                });
            } else {
                // Enter modal fullscreen
                modal.classList.add('modal-fullscreen');
                modalContent.classList.add('max-w-none', 'w-full', 'h-full', 'm-0');
                modalContent.classList.remove('max-w-4xl', 'max-h-[80vh]');
                fullscreenIcon.setAttribute('data-lucide', 'minimize');
                fullscreenButton.title = 'Exit fullscreen';
                
                // Expand preview content areas to use available space
                const previewAreas = modal.querySelectorAll('.preview-content-area');
                previewAreas.forEach(area => {
                    area.style.maxHeight = 'calc(100vh - 250px)';
                    area.style.height = 'calc(100vh - 250px)';
                });
            }
            
            // Re-initialize lucide icons
            setTimeout(() => {
                lucide.createIcons();
            }, 100);
        }

        // Helper function to format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Progress functions
        async function loadProgress() {
            try {
                const response = await fetch('/api/progress');
                const progress = await response.json();
                
                document.getElementById('progress-percentage').textContent = `${progress.completion_percentage}%`;
                document.getElementById('progress-bar').style.width = `${progress.completion_percentage}%`;
                document.getElementById('total-topics').textContent = progress.total_topics;
                document.getElementById('completed-topics').textContent = progress.completed_topics;
                document.getElementById('in-progress-topics').textContent = progress.in_progress_topics;
                document.getElementById('not-started-topics').textContent = progress.not_started_topics;
                document.getElementById('points-display').textContent = `${progress.points} Points`;
                document.getElementById('level-display').textContent = `Level ${progress.level}`;
            } catch (error) {
                console.error('Error loading progress:', error);
            }
        }

        // Achievement functions
        async function checkForNewAchievements() {
            try {
                const response = await fetch('/api/achievements');
                const achievements = await response.json();
                
                if (achievements.length > 0) {
                    const latest = achievements[0];
                    showAchievementPopup(latest.title, latest.description);
                }
            } catch (error) {
                console.error('Error checking achievements:', error);
            }
        }

        function showAchievementPopup(title, description) {
            const popup = document.getElementById('achievement-popup');
            document.getElementById('achievement-title').textContent = title;
            document.getElementById('achievement-description').textContent = description;
            
            popup.classList.remove('hidden');
            
            setTimeout(() => {
                popup.classList.add('hidden');
            }, 5000);
        }

        // Data management functions
        let selectedExcelFile = null;
        let excelPreviewData = null;

        async function loadSampleData() {
            try {
                const response = await fetch('/api/sample-data', { method: 'POST' });
                const result = await response.json();
                
                if (response.ok) {
                    loadTopics();
                    loadProgress();
                    showSuccessMessage(`Sample data loaded successfully! ${result.count} topics added.`);
                } else {
                    showErrorMessage('Error loading sample data: ' + result.error);
                }
            } catch (error) {
                console.error('Error loading sample data:', error);
                showErrorMessage('Error loading sample data.');
            }
        }

        function handleExcelUpload() {
            const fileInput = document.getElementById('excel-upload');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            selectedExcelFile = file;
            document.getElementById('preview-btn').classList.remove('hidden');
            
            // Auto-preview the file
            previewExcel();
        }

        async function previewExcel() {
            if (!selectedExcelFile) {
                showErrorMessage('Please select an Excel file first.');
                return;
            }
            
            const formData = new FormData();
            formData.append('excel', selectedExcelFile);
            
            try {
                showToast('Analyzing Excel file...', 'info');
                
                const response = await fetch('/api/preview-excel', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    excelPreviewData = result;
                    showExcelPreview(result);
                } else {
                    showErrorMessage('Error previewing Excel file: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error previewing Excel file:', error);
                showErrorMessage('Network error: Unable to connect to server. Please ensure the server is running.');
            }
        }

        function showExcelPreview(data) {
            const content = document.getElementById('excel-preview-content');
            
            content.innerHTML = `
                <div class="space-y-6">
                    <!-- File Overview -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="font-medium text-gray-900 mb-3">File Overview</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">Total Sheets: <strong>${data.totalSheets}</strong></p>
                                <p class="text-sm text-gray-600">Expected Structure: A1 (Level), B1 (Task), C/D (Details)</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 mb-2">Sheet Names:</p>
                                <div class="flex flex-wrap gap-1">
                                    ${data.sheetNames.map(name => 
                                        `<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">${name}</span>`
                                    ).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sheets Preview -->
                    <div>
                        <h4 class="font-medium text-gray-900 mb-3">Sheets Preview (First 3 sheets)</h4>
                        <div class="space-y-4">
                            ${data.sheetsPreview.slice(0, 3).map(sheet => `
                                <div class="border border-gray-200 rounded-lg p-4">
                                    <div class="flex justify-between items-start mb-3">
                                        <h5 class="font-medium text-gray-900">Sheet ${sheet.index}: ${sheet.sheetName}</h5>
                                        ${sheet.error ? 
                                            `<span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded">Error</span>` :
                                            `<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">Valid</span>`
                                        }
                                    </div>
                                    
                                    ${sheet.error ? `
                                        <p class="text-red-600 text-sm">${sheet.error}</p>
                                    ` : `
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                                            <div class="bg-blue-50 rounded p-3">
                                                <p class="text-sm font-medium text-blue-900">Level (A1):</p>
                                                <p class="text-sm text-blue-700">${sheet.level}</p>
                                            </div>
                                            <div class="bg-green-50 rounded p-3">
                                                <p class="text-sm font-medium text-green-900">Task Name (B1):</p>
                                                <p class="text-sm text-green-700">${sheet.taskName}</p>
                                            </div>
                                        </div>
                                        ${sheet.structureData && sheet.structureData.length > 0 ? `
                                            <div class="bg-gray-50 rounded p-3">
                                                <p class="text-sm font-medium text-gray-900 mb-2">Structure Data (C/D columns):</p>
                                                <div class="max-h-32 overflow-y-auto">
                                                    ${sheet.structureData.slice(0, 5).map(item => `
                                                        <div class="text-xs text-gray-600 mb-1">
                                                            <strong>Row ${item.row}:</strong> ${item.label}  ${item.value}
                                                        </div>
                                                    `).join('')}
                                                    ${sheet.structureData.length > 5 ? 
                                                        `<p class="text-xs text-gray-500 italic">... and ${sheet.structureData.length - 5} more rows</p>` : 
                                                        ''
                                                    }
                                                </div>
                                            </div>
                                        ` : `
                                            <div class="bg-yellow-50 border border-yellow-200 rounded p-3">
                                                <p class="text-sm text-yellow-800">No structured data found in C/D columns</p>
                                            </div>
                                        `}
                                    `}
                                </div>
                            `).join('')}
                            
                            ${data.sheetsPreview.length > 3 ? `
                                <div class="text-center bg-gray-50 rounded-lg p-4">
                                    <p class="text-sm text-gray-600">... and ${data.sheetsPreview.length - 3} more sheets will be processed</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- Import Summary -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h4 class="font-medium text-blue-900 mb-2">Import Process</h4>
                        <ul class="text-sm text-blue-700 space-y-1">
                            <li> Each sheet will become one learning topic</li>
                            <li> Task Name (B1) will be used as the topic title</li>
                            <li> Level (A1) will be used as the category</li>
                            <li> All C/D column data will be combined into the description</li>
                            <li> Sheet names will be used for module organization</li>
                        </ul>
                    </div>
                </div>
            `;
            
            document.getElementById('excel-preview-modal').classList.remove('hidden');
            
            // Reset scroll position to top for better user experience
            const modal = document.getElementById('excel-preview-modal');
            const modalContent = modal.querySelector('.max-h-\\[80vh\\]');
            if (modalContent) {
                modalContent.scrollTop = 0;
            }
        }

        function closeExcelPreview() {
            document.getElementById('excel-preview-modal').classList.add('hidden');
            excelPreviewData = null;
        }

        async function proceedWithImport() {
            if (!selectedExcelFile) {
                showErrorMessage('No file selected for import.');
                return;
            }
            
            const formData = new FormData();
            formData.append('excel', selectedExcelFile);
            
            try {
                showToast('Importing Excel file...', 'info');
                
                const response = await fetch('/api/upload-excel', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    closeExcelPreview();
                    loadTopics();
                    loadProgress();
                    
                    let message = `Excel file imported successfully! ${result.count} topics added from ${result.totalSheets} sheets.`;
                    if (result.errors && result.errors.length > 0) {
                        message += `\n\nWarnings:\n${result.errors.slice(0, 3).join('\n')}`;
                        if (result.errors.length > 3) {
                            message += `\n... and ${result.errors.length - 3} more warnings.`;
                        }
                    }
                    
                    showSuccessMessage(message);
                    
                    // Reset file input
                    document.getElementById('excel-upload').value = '';
                    selectedExcelFile = null;
                    document.getElementById('preview-btn').classList.add('hidden');
                } else {
                    showErrorMessage('Error importing Excel file: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error uploading Excel file:', error);
                showErrorMessage('Network error: Unable to connect to server. Please ensure the server is running.');
            }
        }


        // Clear curriculum function
        async function clearCurriculum() {
            if (!confirm('Are you sure you want to clear ALL curriculum data? This action cannot be undone.')) {
                return;
            }
            
            try {
                showToast('Clearing curriculum data...', 'info');
                
                const response = await fetch('/api/clear-curriculum', {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    loadTopics();
                    loadProgress();
                    showSuccessMessage('All curriculum data cleared successfully!');
                } else {
                    showErrorMessage('Error clearing curriculum: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error clearing curriculum:', error);
                showErrorMessage('Network error: Unable to connect to server. Please ensure the server is running.');
            }
        }

        // Utility functions for user feedback
        function showSuccessMessage(message) {
            showToast(message, 'success');
        }

        function showErrorMessage(message) {
            showToast(message, 'error');
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white max-w-sm ${
                type === 'success' ? 'bg-green-600' : 
                type === 'error' ? 'bg-red-600' : 'bg-blue-600'
            }`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        // View toggle
        function toggleView() {
            isGridView = !isGridView;
            const button = document.getElementById('view-toggle');
            
            if (isGridView) {
                button.innerHTML = '<i data-lucide="list" class="w-4 h-4 inline mr-2"></i>Switch to Module View';
            } else {
                button.innerHTML = '<i data-lucide="grid" class="w-4 h-4 inline mr-2"></i>Switch to Grid View';
            }
            
            renderTopics(currentTopics);
        }

        // Questions management functions
        function toggleQuestionInput(inputId) {
            const inputDiv = document.getElementById(inputId);
            const isHidden = inputDiv.classList.contains('hidden');
            
            if (isHidden) {
                inputDiv.classList.remove('hidden');
                // Focus on the input field
                const input = inputDiv.querySelector('input');
                setTimeout(() => input.focus(), 100);
            } else {
                inputDiv.classList.add('hidden');
                // Clear the input
                const input = inputDiv.querySelector('input');
                input.value = '';
            }
        }

        async function addQuestion(topicId) {
            const input = document.getElementById(`question-input-${topicId}`);
            const questionText = input.value.trim();
            
            if (!questionText) return;
            
            try {
                const response = await fetch(`/api/topics/${topicId}/questions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ text: questionText })
                });
                
                if (response.ok) {
                    input.value = '';
                    toggleQuestionInput(`questions-${topicId}`);
                    // Update only the specific topic instead of reloading all topics
                    await updateTopicInPlace(topicId);
                    showSuccessMessage('Question added successfully!');
                } else {
                    showErrorMessage('Error adding question');
                }
            } catch (error) {
                console.error('Error adding question:', error);
                showErrorMessage('Error adding question');
            }
        }

        async function removeQuestion(topicId, questionIndex) {
            if (!confirm('Are you sure you want to delete this question?')) return;
            
            try {
                const response = await fetch(`/api/topics/${topicId}/questions/${questionIndex}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    // Update only the specific topic instead of reloading all topics
                    await updateTopicInPlace(topicId);
                    showSuccessMessage('Question deleted successfully!');
                } else {
                    showErrorMessage('Error deleting question');
                }
            } catch (error) {
                console.error('Error deleting question:', error);
                showErrorMessage('Error deleting question');
            }
        }

        async function toggleQuestionStatus(topicId, questionIndex) {
            try {
                const response = await fetch(`/api/topics/${topicId}/questions/${questionIndex}/toggle`, {
                    method: 'PUT'
                });
                
                if (response.ok) {
                    // Update only the specific topic instead of reloading all topics
                    await updateTopicInPlace(topicId);
                } else {
                    showErrorMessage('Error updating question status');
                }
            } catch (error) {
                console.error('Error updating question status:', error);
                showErrorMessage('Error updating question status');
            }
        }

        // Helper function to update a specific topic without collapsing the view
        async function updateTopicInPlace(topicId) {
            try {
                console.log('updateTopicInPlace called for topic:', topicId);
                
                // Get the updated topic data
                const response = await fetch(`/api/topics/${topicId}`);
                if (!response.ok) {
                    console.error('Failed to fetch updated topic:', response.status);
                    return;
                }
                
                const updatedTopic = await response.json();
                console.log('Updated topic data:', updatedTopic);
                
                // Update the currentTopics array
                const topicIndex = currentTopics.findIndex(t => t.id === topicId);
                if (topicIndex !== -1) {
                    currentTopics[topicIndex] = updatedTopic;
                    
                    // Update just the questions list instead of the entire topic
                    const questionsListElement = document.getElementById(`questions-list-${topicId}`);
                    if (questionsListElement) {
                        // Render the questions HTML
                        const questionsHTML = updatedTopic.questions ? updatedTopic.questions.map((question, index) => `
                            <div class="question-item ${question.answered ? 'question-answered' : ''} bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-3 group">
                                <div class="flex items-start justify-between">
                                    <p class="question-text text-sm text-yellow-800 dark:text-yellow-200 flex-1">${question.text}</p>
                                    <div class="flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity ml-2">
                                        ${question.answered ? `
                                            <button onclick="event.stopPropagation(); toggleQuestionStatus(${topicId}, ${index})" 
                                                    class="text-green-600 hover:text-green-700 dark:text-green-400" title="Mark as unanswered">
                                                <i data-lucide="check-circle" class="w-4 h-4"></i>
                                            </button>
                                        ` : `
                                            <button onclick="event.stopPropagation(); toggleQuestionStatus(${topicId}, ${index})" 
                                                    class="text-gray-400 hover:text-green-600 dark:text-gray-500 dark:hover:text-green-400" title="Mark as answered">
                                                <i data-lucide="circle" class="w-4 h-4"></i>
                                            </button>
                                        `}
                                        <button onclick="event.stopPropagation(); removeQuestion(${topicId}, ${index})" 
                                                class="text-red-400 hover:text-red-600 dark:text-red-500 dark:hover:text-red-400" title="Delete question">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                                ${question.answered ? `
                                    <div class="mt-2 flex items-center text-xs text-green-600 dark:text-green-400">
                                        <i data-lucide="check" class="w-3 h-3 mr-1"></i>
                                        Answered
                                    </div>
                                ` : ''}
                            </div>
                        `).join('') : '';
                        
                        // Add empty state if no questions
                        const emptyState = (!updatedTopic.questions || updatedTopic.questions.length === 0) ? 
                            `<p class="text-xs text-gray-500 dark:text-gray-400 italic">No questions yet. Click "Add Question" to start tracking your learning questions.</p>` : '';
                        
                        questionsListElement.innerHTML = questionsHTML + emptyState;
                        
                        // Re-initialize lucide icons
                        lucide.createIcons();
                        console.log('Updated questions list successfully');
                    } else {
                        console.error('Could not find questions list element for topic:', topicId);
                        // Fallback to full reload
                        loadTopics();
                    }
                }
            } catch (error) {
                console.error('Error updating topic in place:', error);
                // Fallback to full reload if in-place update fails
                loadTopics();
            }
        }

        // Close modal when clicking outside
        document.getElementById('topic-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        document.getElementById('excel-preview-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeExcelPreview();
            }
        });

        // Modal event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Close modal when clicking outside
            document.getElementById('topic-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });

            document.getElementById('excel-preview-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeExcelPreview();
                }
            });

            document.getElementById('file-preview-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeFilePreview();
                }
            });
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
                closeExcelPreview();
                closeFilePreview();
                
                // Exit fullscreen on ESC
                if (isFullscreen) {
                    exitFullscreen();
                }
            }
            
            // F11 for fullscreen toggle
            if (e.key === 'F11') {
                e.preventDefault();
                toggleFullscreen();
            }
        });
    </script>
</body>
    <script>
    // Timer logic
    let timerInterval = null;
    let timerEndTimeout = null;
    let timerStartTime = null;
    let timerDuration = 60 * 60; // 1 hour in seconds
    let timerRunning = false;

    function formatTimeLeft(seconds) {
        const m = Math.floor(seconds / 60).toString().padStart(2, '0');
        const s = (seconds % 60).toString().padStart(2, '0');
        return `${m}:${s}`;
    }

    function showTimerNotification(message) {
        const notif = document.getElementById('timer-notification');
        document.getElementById('timer-message').textContent = message;
        notif.classList.remove('hidden');
        setTimeout(() => notif.classList.add('hidden'), 6000);
    }

    function saveSessionToDB(startTime, endTime, duration) {
        fetch('/api/session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ startTime, endTime, duration })
        });
    }

    function startLearningTimer() {
        if (timerRunning) return;
        timerRunning = true;
        timerStartTime = new Date();
        let timeLeft = timerDuration;
        const timerDisplay = document.getElementById('timer-display');
        timerDisplay.classList.remove('hidden');
        timerDisplay.textContent = formatTimeLeft(timeLeft);

        // Save session start to DB (endTime/duration null for now)
        saveSessionToDB(timerStartTime.toISOString(), null, null);

        timerInterval = setInterval(() => {
            timeLeft--;
            timerDisplay.textContent = formatTimeLeft(timeLeft);
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }, 1000);

        timerEndTimeout = setTimeout(() => {
            timerRunning = false;
            timerDisplay.classList.add('hidden');
            showTimerNotification('Session expired!');
            // Save session end to DB
            const endTime = new Date();
            saveSessionToDB(timerStartTime.toISOString(), endTime.toISOString(), timerDuration);
        }, timerDuration * 1000);
    }

    // ========================================
    // SIMPLE TIME TRACKING IMPLEMENTATION
    // ========================================
    
    let currentLearningSessionId = null;
    let learningStartTime = null;
    let learningTimerInterval = null;
    let isLearningInProgress = false;
    let currentLearningCalendarDate = new Date();
    
    // Toggle learning timer between start and stop
    async function toggleLearningTimer() {
        if (isLearningInProgress) {
            await stopLearningTimer();
        } else {
            await startLearningTimer();
        }
    }
    
    // Start learning timer
    async function startLearningTimer() {
        try {
            console.log('Starting learning timer - making fetch request...');
            const response = await fetch('/api/time-tracking/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            console.log('Fetch response received:', response.status, response.ok);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Server error response:', errorText);
                throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
            }
            
            const data = await response.json();
            console.log('Response data:', data);
            
            // Set learning timer state
            currentLearningSessionId = data.sessionId;
            learningStartTime = new Date(data.startTime);
            isLearningInProgress = true;
            
            // Set header session state
            sessionStartTime = learningStartTime;
            currentSessionMinutes = 0;
            
            // Update main timer button
            const btn = document.getElementById('learning-control-btn');
            if (!btn) {
                throw new Error('learning-control-btn element not found');
            }
            btn.innerHTML = '<i data-lucide="square" class="w-5 h-5 inline mr-2"></i>Stop Learning';
            btn.className = 'bg-red-600 hover:bg-red-700 text-white px-8 py-3 rounded-lg text-lg font-semibold transition-colors';
            
            // Update header session buttons
            const startBtn = document.getElementById('start-session-btn');
            const terminateBtn = document.getElementById('terminate-session-btn');
            if (!startBtn || !terminateBtn) {
                throw new Error('Session control buttons not found');
            }
            startBtn.classList.add('hidden');
            terminateBtn.classList.remove('hidden');
            
            // Start both timer displays
            startLearningTimerDisplay();
            sessionInterval = setInterval(updateSessionTimer, 1000);
            
            // Re-initialize lucide icons
            setTimeout(() => lucide.createIcons(), 100);
            
            console.log('Learning session started:', data);
            
        } catch (error) {
            console.error('Error starting learning session:', error);
            console.error('Error details:', error.message, error.stack);
            alert('Failed to start learning session: ' + error.message + '. Please try again.');
        }
    }
    
    // Stop learning timer
    async function stopLearningTimer() {
        if (!currentLearningSessionId) {
            console.error('No active session to stop');
            return;
        }
        
        try {
            const response = await fetch('/api/time-tracking/stop', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    sessionId: currentLearningSessionId
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            // Reset learning timer state
            currentLearningSessionId = null;
            learningStartTime = null;
            isLearningInProgress = false;
            
            // Reset header session state
            sessionStartTime = null;
            currentSessionMinutes = 0;
            if (sessionInterval) {
                clearInterval(sessionInterval);
                sessionInterval = null;
            }
            
            // Stop timer display
            stopLearningTimerDisplay();
            
            // Update main timer button
            const btn = document.getElementById('learning-control-btn');
            btn.innerHTML = '<i data-lucide="play" class="w-5 h-5 inline mr-2"></i>Start Learning';
            btn.className = 'bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg text-lg font-semibold transition-colors';
            
            // Update header session buttons
            const startBtn = document.getElementById('start-session-btn');
            const terminateBtn = document.getElementById('terminate-session-btn');
            if (startBtn) startBtn.classList.remove('hidden');
            if (terminateBtn) terminateBtn.classList.add('hidden');
            
            // Reset session timer display
            document.getElementById('session-timer').textContent = '00:00:00';
            
            // Update displays
            await updateTotalLearningTimeDisplay();
            await loadTimeTrackingCalendar();
            
            // Re-initialize lucide icons
            setTimeout(() => lucide.createIcons(), 100);
            
            console.log('Learning session stopped:', data);
            console.log(`Session duration: ${Math.floor(data.duration / 60)} minutes ${data.duration % 60} seconds`);
            
        } catch (error) {
            console.error('Error stopping learning session:', error);
            alert('Failed to stop learning session. Please try again.');
        }
    }
    
    // Start the timer display
    function startLearningTimerDisplay() {
        if (learningTimerInterval) {
            clearInterval(learningTimerInterval);
        }
        
        learningTimerInterval = setInterval(() => {
            if (learningStartTime) {
                const now = new Date();
                const elapsed = Math.floor((now - learningStartTime) / 1000);
                updateLearningTimerDisplay(elapsed);
            }
        }, 1000);
    }
    
    // Stop the timer display
    function stopLearningTimerDisplay() {
        if (learningTimerInterval) {
            clearInterval(learningTimerInterval);
            learningTimerInterval = null;
        }
        
        // Reset display
        document.getElementById('learning-timer-display').textContent = '00:00:00';
    }
    
    // Update the timer display
    function updateLearningTimerDisplay(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        
        const timeStr = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        document.getElementById('learning-timer-display').textContent = timeStr;
    }
    
    // Update total learning time display
    async function updateTotalLearningTimeDisplay() {
        try {
            const response = await fetch('/api/time-tracking/today');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            const totalTimeDisplay = document.getElementById('total-time-display');
            console.log('Total time display element:', totalTimeDisplay);
            if (totalTimeDisplay) {
                const hours = Math.floor(data.totalMinutes / 60);
                const minutes = Math.floor(data.totalMinutes % 60);
                const newText = `Today: ${hours}h ${minutes}m`;
                console.log('Updating total time display to:', newText);
                totalTimeDisplay.textContent = newText;
                console.log('Display updated. Current text:', totalTimeDisplay.textContent);
            } else {
                console.error('total-time-display element not found!');
            }
            
            console.log('Today\'s learning time:', data);
            
        } catch (error) {
            console.error('Error updating total time display:', error);
        }
    }
    
    // Load learning calendar
    async function loadLearningCalendar() {
        try {
            const response = await fetch('/api/calendar');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const calendarData = await response.json();
            
            // Update calendar display
            generateLearningCalendar(calendarData);
            
            console.log('Learning calendar data loaded:', calendarData);
            
        } catch (error) {
            console.error('Error loading learning calendar:', error);
        }
    }
    
    // Generate learning calendar
    function generateLearningCalendar(timeData) {
        const calendarDays = document.getElementById('learning-calendar-days');
        if (!calendarDays) return;
        
        // Clear existing content
        calendarDays.innerHTML = '';
        
        const year = currentLearningCalendarDate.getFullYear();
        const month = currentLearningCalendarDate.getMonth();
        
        // Get first day of month and number of days
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDayOfWeek = firstDay.getDay();
        
        // Add empty cells for days before the first day of the month
        for (let i = 0; i < startingDayOfWeek; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.className = 'h-8';
            calendarDays.appendChild(emptyDay);
        }
        
        // Add days of the month
        const today = new Date();
        const todayString = today.toISOString().split('T')[0];
        
        for (let day = 1; day <= daysInMonth; day++) {
            const dayElement = document.createElement('div');
            const dayDate = new Date(year, month, day);
            const dayString = dayDate.toISOString().split('T')[0];
            
            dayElement.className = 'h-8 w-8 rounded-full flex items-center justify-center text-sm cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700';
            dayElement.textContent = day;
            
            // Check if this day has learning data
            const dayData = timeData[dayString];
            
            if (dayData && dayData.hasActivity) {
                // Day with learning activity
                if (dayData.totalMinutes >= 60) {
                    // Good day (60+ minutes) - green
                    dayElement.classList.add('bg-green-500', 'text-white');
                    dayElement.title = `${dayData.totalMinutes} minutes learned (${dayData.sessions} sessions)`;
                } else {
                    // Some learning but less than 60 minutes - yellow
                    dayElement.classList.add('bg-yellow-400', 'text-white');
                    dayElement.title = `${dayData.totalMinutes} minutes learned (${dayData.sessions} sessions)`;
                }
            } else if (dayString === todayString) {
                // Today but no learning yet - light blue
                dayElement.classList.add('bg-blue-200', 'dark:bg-blue-600', 'text-blue-800', 'dark:text-blue-200');
                dayElement.title = 'Today - no learning recorded yet';
            } else {
                // No learning data - default gray
                dayElement.classList.add('text-gray-600', 'dark:text-gray-400');
                dayElement.title = 'No learning recorded';
            }
            
            calendarDays.appendChild(dayElement);
        }
        
        // Update month/year display
        const monthYearElement = document.getElementById('learning-calendar-month-year');
        if (monthYearElement) {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            monthYearElement.textContent = `${monthNames[month]} ${year}`;
        }
    }
    
    // Change learning calendar month
    function changeLearningCalendarMonth(direction) {
        currentLearningCalendarDate.setMonth(currentLearningCalendarDate.getMonth() + direction);
        loadTimeTrackingCalendar();
    }
    
    // Initialize time tracking on page load
    async function initializeLearningTimeTracking() {
        await updateTotalLearningTimeDisplay();
        await loadTimeTrackingCalendar();
    }
    
    // ========================================
    // END SIMPLE TIME TRACKING IMPLEMENTATION
    // ========================================

    // ========================================
    // NEW TIME TRACKING IMPLEMENTATION
    // ========================================
    
    let currentSessionId = null;
    let trackingStartTime = null;
    let trackingInterval = null;
    let isLearningActive = false;
    
    // Toggle between start and stop learning
    async function toggleLearningSession() {
        if (isLearningActive) {
            await stopLearning();
        } else {
            await startLearning();
        }
    }
    
    // Start a new learning session
    async function startLearning() {
        try {
            const response = await fetch('/api/time-tracking/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            currentSessionId = data.sessionId;
            trackingStartTime = new Date(data.startTime);
            isLearningActive = true;
            
            // Update button appearance
            const btn = document.getElementById('start-learning-btn');
            btn.innerHTML = '<i data-lucide="square" class="w-5 h-5 inline mr-2"></i>Stop Learning';
            btn.className = 'bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg text-lg font-semibold transition-colors';
            
            // Show timer display
            const timerDisplay = document.getElementById('timer-display');
            timerDisplay.classList.remove('hidden');
            
            // Start the timer
            startTimer();
            
            // Update total time display
            await updateTotalTimeDisplay();
            
            console.log('Learning session started:', data);
            
        } catch (error) {
            console.error('Error starting learning session:', error);
            alert('Failed to start learning session. Please try again.');
        }
    }
    
    // Stop the current learning session
    async function stopLearning() {
        if (!currentSessionId) {
            console.error('No active session to stop');
            return;
        }
        
        try {
            const response = await fetch('/api/time-tracking/stop', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    sessionId: currentSessionId
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            // Reset state
            currentSessionId = null;
            trackingStartTime = null;
            isLearningActive = false;
            
            // Stop timer
            stopTimer();
            
            // Update button appearance
            const btn = document.getElementById('start-learning-btn');
            btn.innerHTML = '<i data-lucide="timer" class="w-5 h-5 inline mr-2"></i>Start Learning';
            btn.className = 'bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg text-lg font-semibold transition-colors';
            
            // Hide timer display
            const timerDisplay = document.getElementById('timer-display');
            timerDisplay.classList.add('hidden');
            
            // Update total time display and calendar
            await updateTotalTimeDisplay();
            await loadTimeTrackingCalendar();
            
            console.log('Learning session stopped:', data);
            console.log(`Session duration: ${Math.floor(data.duration / 60)} minutes ${data.duration % 60} seconds`);
            
        } catch (error) {
            console.error('Error stopping learning session:', error);
            alert('Failed to stop learning session. Please try again.');
        }
    }
    
    // Start the visual timer
    function startTimer() {
        if (trackingInterval) {
            clearInterval(trackingInterval);
        }
        
        trackingInterval = setInterval(() => {
            if (trackingStartTime) {
                const now = new Date();
                const elapsed = Math.floor((now - trackingStartTime) / 1000);
                updateTimerDisplay(elapsed);
            }
        }, 1000);
    }
    
    // Stop the visual timer
    function stopTimer() {
        if (trackingInterval) {
            clearInterval(trackingInterval);
            trackingInterval = null;
        }
    }
    
    // Update the timer display
    function updateTimerDisplay(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        
        const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        
        const timerText = document.getElementById('timer-text');
        if (timerText) {
            timerText.textContent = timeString;
        }
    }
    
    // Update total time display in the header
    async function updateTotalTimeDisplay() {
        try {
            const response = await fetch('/api/time-tracking/today');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            // Update the session timer in header if it exists
            const sessionTimer = document.getElementById('session-timer');
            if (sessionTimer) {
                const hours = Math.floor(data.totalMinutes / 60);
                const minutes = Math.floor(data.totalMinutes % 60);
                sessionTimer.textContent = `${hours}h ${minutes}m today`;
            }
            
            console.log('Today\'s learning time:', data);
            
        } catch (error) {
            console.error('Error updating total time display:', error);
        }
    }
    
    // Load calendar with time tracking data
    async function loadTimeTrackingCalendar() {
        try {
            const response = await fetch('/api/time-tracking/calendar');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const result = await response.json();
            const calendarData = result.data || {};
            
            // Update calendar display
            generateCalendarWithTimeData(calendarData);
            
            console.log('Time tracking calendar data loaded:', calendarData);
            
        } catch (error) {
            console.error('Error loading time tracking calendar:', error);
        }
    }
    
    // Generate calendar with time tracking data
    function generateCalendarWithTimeData(timeData) {
        console.log('generateCalendarWithTimeData called with:', timeData);
        
        const calendarDays = document.getElementById('calendar-days');
        if (!calendarDays) {
            console.error('calendar-days element not found!');
            return;
        }
        
        // Clear existing content
        calendarDays.innerHTML = '';
        
        const year = currentTimeTrackingCalendarDate.getFullYear();
        const month = currentTimeTrackingCalendarDate.getMonth();
        
        console.log('Generating calendar for:', year, month + 1);
        
        // Get first day of month and number of days
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDayOfWeek = firstDay.getDay();
        
        // Add empty cells for days before month starts
        for (let i = 0; i < startingDayOfWeek; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.className = 'h-8';
            calendarDays.appendChild(emptyDay);
        }
        
        // Add days of month
        for (let day = 1; day <= daysInMonth; day++) {
            const dayElement = document.createElement('div');
            const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const dayData = timeData[dateString];
            
            dayElement.className = 'h-8 flex items-center justify-center text-sm cursor-default relative';
            dayElement.textContent = day;
            
            // Debug today's date specifically
            const todayDate = new Date();
            if (year === todayDate.getFullYear() && month === todayDate.getMonth() && day === todayDate.getDate()) {
                console.log(`Today (${dateString}) data:`, dayData);
            }
            
            if (dayData && dayData.hasActivity) {
                console.log(`Day ${day} (${dateString}) has activity:`, dayData);
                
                // Color based on learning time
                if (dayData.totalMinutes >= 60) {
                    dayElement.className += ' bg-green-500 text-white font-semibold rounded';
                    console.log(`Applied dark green to day ${day}`);
                } else if (dayData.totalMinutes >= 30) {
                    dayElement.className += ' bg-green-300 text-green-800 font-medium rounded';
                    console.log(`Applied medium green to day ${day}`);
                } else if (dayData.totalSeconds > 0) {
                    // Show light green for any activity, even under 1 minute
                    dayElement.className += ' bg-green-100 text-green-700 rounded';
                    console.log(`Applied light green to day ${day}`);
                }
                
                // Add tooltip with time info
                const displayTime = dayData.totalMinutes > 0 
                    ? `${dayData.totalMinutes} minutes` 
                    : `${dayData.totalSeconds} seconds`;
                dayElement.title = `${displayTime} learned (${dayData.sessions} sessions)`;
            } else {
                dayElement.className += ' text-gray-400 dark:text-gray-600';
            }
            
            // Highlight today
            const today = new Date();
            if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                dayElement.className += ' ring-2 ring-blue-500';
            }
            
            calendarDays.appendChild(dayElement);
        }
        
        // Update month/year display
        const monthYearElement = document.getElementById('calendar-month-year');
        if (monthYearElement) {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            monthYearElement.textContent = `${monthNames[month]} ${year}`;
        }
    }
    
    // Calendar navigation functions
    function changeTimeTrackingCalendarMonth(direction) {
        currentTimeTrackingCalendarDate.setMonth(currentTimeTrackingCalendarDate.getMonth() + direction);
        loadTimeTrackingCalendar();
    }
    
    // Initialize time tracking on page load
    async function initializeTimeTracking() {
        await updateTotalTimeDisplay();
        await loadTimeTrackingCalendar();
    }
    
    // ========================================
    // END NEW TIME TRACKING IMPLEMENTATION
    // ========================================

    </script>

    <!-- Time Tracker Components -->
    <script src="./session-state-manager.js"></script>
    <script src="./time-tracker-component.js"></script>
    
    <script>
        // Initialize Time Tracker Component
        let timeTracker;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the time tracker component without container (uses existing elements)
            timeTracker = new TimeTrackerComponent();
            
            // Initialize existing time tracking functionality
            if (typeof initializeTimeTracking === 'function') {
                initializeTimeTracking();
            }
        });
        
        // Keyboard shortcut for time tracking (Ctrl+Shift+L)
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.shiftKey && e.key === 'L') {
                e.preventDefault();
                if (timeTracker) {
                    timeTracker.handleButtonClick();
                }
            }
        });
        
        // Handle fullscreen toggle
        document.addEventListener('keydown', function(e) {
            if (e.key === 'F11') {
                e.preventDefault();
                toggleFullscreen();
            }
        });
    </script>
</body>
</html>
